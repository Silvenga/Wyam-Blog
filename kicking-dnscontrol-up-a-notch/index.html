 <!doctype html> <html lang=en-us dir=ltr> <head> <meta charset=utf-8 /> <meta http-equiv=Content-Type content=text/html /> <meta name=HandheldFriendly content=True /> <meta name=viewport content="width=device-width,initial-scale=1"/> <meta name=generator content="Wyam + Webpack"/> <meta name=theme-color content=#000000 /> <title>Kicking DnsControl Up a Notch with Typescript</title> <meta name=description content="Improving &quot;DNS as Code&quot; with type checking and Intellisense"> <meta property=og:type content=website> <meta property=og:title content="Kicking DnsControl Up a Notch with Typescript"> <meta property=og:description content="Improving &quot;DNS as Code&quot; with type checking and Intellisense"> <meta property=og:locale content=en_US> <meta name=twitter:card content=summary> <meta name=twitter:site content=@Silvenga> <meta name=twitter:creator content=@Silvenga> <link rel=prefetch href=/gist-loader.js> <link rel=prefetch href=/gist-loader> <link rel=preconnect href=https://matomo.silvenga.com> <link rel=preload href=https://matomo.silvenga.com/piwik.js as=script> <link rel=preload href=/main.js as=script> <link rel=stylesheet href=/main.css> </head> <body> <header class="container-fluid s-nav" id=loading-bar role=banner> <nav class="navbar row" role=navigation> <div class="nav col-sm d-flex s-nav-left p-0"> <a class="nav-item nav-link" href=/ > <span class=logo></span> Silvenga's Blog </a> </div> <div class="nav col-sm s-nav-right p-0"> <a class="nav-item nav-link" href=/projects/ >Projects</a> <a class="nav-item nav-link" href=/about/ >About</a> <a class="nav-item nav-link" href=https://github.com/Silvenga aria-label=Github><span class=github></span></a> </div> </nav> </header> <div id=ajax-container> <script type=application/ld+json> {
  "@context" : "http://schema.org",
  "@type" : "Article",
  "headline" : "Kicking DnsControl Up a Notch with Typescript",
  "datePublished" : "2018-02-11T00:00:00.0000000",
  "dateModified": "2018-02-11T23:18:32.0000000-06:00",
  "author": {
      "name": "Mark Lopez"
  },
  "description": "Improving &quot;DNS as Code&quot; with type checking and Intellisense"
} </script> <article class="s-content pt-4 m-4 flex-column align-items-stretch"> <div class="flex-column d-flex justify-content-center align-items-center"> <div class=s-title> <h1 class="display-4 text-center">Kicking DnsControl Up a Notch with Typescript</h1> <div class=text-center> Created on <time datetime=2018-02-11T00:00:00.0000000>February 11, 2018</time>. </div> <div class=text-center> Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/2ddea43e>2ddea43e</a> on <time datetime=2018-02-11T23:18:32.0000000-06:00>February 11, 2018</time> - 1 total changes. </div> <hr> </div> </div> <div class="justify-content-center mt-2"> <main class="s-article d-flex flex-column align-items-center" role=main> <p>I love this new era of infrastructure as code being a DevOps developer. I can apply my knowledge of code, beyond just simple scripts and programs, to fully managing my infrastructure - all from the comfort of VSCode and Git.</p> <p>My newest project is the revamping of DNS zones, hopefully moving them back to using code. Historically, I did manage them using code. In fact, I used <code>nsd</code> managed by SaltStack (zones automatically created from YAML). This worked for me for years - but I was never really happy with it. My custom templates were fragile and my deployments would randomly break. I ended up switching my primary domains over to other hosted DNS providers because I needed the reliability. Throughout the years, I actually went through a bunch of providers:</p> <ul> <li>Amazon Route53</li> <li>DNSimple</li> <li>DNSMadeEasy</li> <li>CloudFlare</li> <li>DigitalOcean</li> <li>Afraid DNS</li> <li>Hurricane Electric (Yes, they provide free DNS services)</li> </ul> <p>Oh, yeah, did I mention I have 32 domains? Needless to say my DNS infrastructure was fragmented - that is until I found DnsControl.</p> <h2 id=dnscontrol>DnsControl</h2> <p>DnsControl saved my sanity - as simple as that. Using DnsControl I could create zones in a portable format and synchronize with the different DNS providers I used (almost all of them, I don't have enough golang knowledge to implement a DNSMadeEasy provider). <a href=https://blog.serverfault.com/2017/04/11/introducing-dnscontrol-dns-as-code-has-arrived/ >Craig Peterson</a> calls it &quot;describe once, use anywhere&quot;.</p> <p>So I went reading though the docs preparing to make the switch and I got worried -the docs kept on talking about this custom DSL that was created for DnsControl. I for one hate custom configuration types since I effectively lose IDE support. They called it a Javascript like language - which got me thinking, if I was a lazy developer (which I am), I wouldn't create a custom language if I could piggyback off an existing one. Is this Javascript-like-DSL actually Javascript?</p> <p>Yes, it turns out that DnsControl is running a golang Javascript runtime internally with custom global functions. This discovery just opened a huge amount of possibilities, what limits could I push with this DSL? After looking a bit further throughout the code I discovered that basically ES5 was supported, with basic module loading support (some might call it a hacked). This didn't worry me so much as I had my sights on something bigger - could I get Webpack to work with this?</p> <h2 id=webpack-typescript>Webpack + Typescript</h2> <p>Yes, it turns out DnsControl had enough ES5 compatibility for Webpack to do it's magic. This of course ment my next logical step had to be to try Typescript, which worked (of course the definitions for the custom DSL didn't exist, more on that later).</p> <p>Below is my rather standard <code>webpack.config.js</code> configuration. I'm also having Webpack manage the <code>creds.json</code> file too, for convenience sake.</p> <div class="code-header lang-file"> <span class=language>webpack.config.js</span> <button class=copy data-copy-id=d188a61d554946f5aa5344b84a1f6662> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-file copy-pending"><code data-copy-target=d188a61d554946f5aa5344b84a1f6662 class=language-file-webpack.config.js>const path = require(&quot;path&quot;);
const CopyWebpackPlugin = require(&quot;copy-webpack-plugin&quot;);

module.exports = {
    entry: &quot;./src/main.ts&quot;,
    output: {
        path: path.resolve(&quot;./output&quot;),
        filename: &quot;dnsconfig.js&quot;
    },
    resolve: {
        extensions: [&quot;.ts&quot;, &quot;.js&quot;],
        modules: [&quot;src&quot;, &quot;node_modules&quot;].map(x =&gt; path.resolve(x)),
    },
    module: {
        loaders: [
            {
                test: /\.ts$/,
                use: [
                    'babel-loader',
                    'ts-loader'
                ],
            }
        ]
    },
    plugins: [
        new CopyWebpackPlugin([
            {
                from: &quot;./src/creds.json&quot;,
                to: &quot;./creds.json&quot;
            }
        ])
    ]
}
</code></pre> <p>I also added some babel-env support (to auto-polyfill ES6 type support, e.g. <code>Map</code>):</p> <div class="code-header lang-file"> <span class=language>.babelrc</span> <button class=copy data-copy-id=f0c8b1424c55404285caaee0ef76ad11> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-file copy-pending"><code data-copy-target=f0c8b1424c55404285caaee0ef76ad11 class=language-file-.babelrc>{
    &quot;presets&quot;: [
        [
            &quot;&#64;babel/preset-env&quot;,
            {
                &quot;useBuiltIns&quot;: &quot;usage&quot;,
                &quot;module&quot;: false
            }
        ]
    ]
}
</code></pre> <p>Of course my next step was to make some type definitions for the custom DSL methods. This one actually took some effort as some of the DSL methods were missing from the documentation (at the time of my search). I eventually just went through the code to find these methods (and their signatures) that I needed. Below are the definitions that I compiled:</p> <div class="code-header lang-file"> <span class=language>global.d.ts</span> <button class=copy data-copy-id=287a7a8040cc4aacabcc65354de7bb10> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-file copy-pending"><code data-copy-target=287a7a8040cc4aacabcc65354de7bb10 class=language-file-global.d.ts>// Version 1
// https://stackexchange.github.io/dnscontrol/js
type Ttl = string | number;

// Top Level Functions
declare function REV(address: string): string;
declare function NewRegistrar(name: string, type: string, meta?: any): string;
declare function NewDnsProvider(name: string, type: string, meta?: any): string;
declare function DEFAULTS(...modifiers: any[]): void;
declare function D(name: string, registrar: string, ...meta: any[]): void;

// Domain Modifiers
declare function A(name: string, address: string, ...modifiers: any[]);
declare function AAAA(name: string, address: string, ...modifiers: any[]);
declare function ALIAS(name: string, target: string, ...modifiers: any[]);
declare function CAA(name: string, tag: string, value: string, ...modifiers: any[]);
declare function CNAME(name: string, target: string, ...modifiers: any[]);
declare function DefaultTTL(ttl: Ttl);
declare function DnsProvider(name: string, nsCount?: number);
declare function MX(name: string, priority: number, target: string, ...modifiers: any[]);
declare function NAMESERVER(name: string, ip?: string, ...modifiers: any[]);
declare function NO_PURGE();
declare function NS(name: string, target: string, ...modifiers: any[]);
declare function PTR(name: string, target: string, ...modifiers: any[]);
declare function NO_PURGE();
declare function TLSA(name: string, usage: number, selector: number, type: number, certificate: string, ...modifiers: any[]);
declare function TXT(name: string, contents: string, ...modifiers: any[]);

declare function SRV(name: string, priority: number, weight: number, port: number, target: string, ...modifiers: any[]);

// Record Modifiers
declare function TTL(ttl: Ttl);
</code></pre> <h2 id=the-result>The Result</h2> <p>With this simple setup I got access to a bunch of neat little features. The options are limitless! Here are a couple of perks I personally loved:</p> <h3 id=typescript>Typescript</h3> <p>Auto-completion support:</p> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\dnscontrol-auto-complete.png data-real-width=599 data-real-height=99 style=max-width:599px><div class=img-container style=padding-top:16.527545909849749582637729550%><p class=img-container-inner><img src="" class=img-fluid data-src=/3a9debe5d04409d49f790f9b31e2079f.png alt="Auto-complete support"/></p></div></div><p></p> <p>Type-checking support:</p> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\dnscontrol-type-checking.png data-real-width=401 data-real-height=88 style=max-width:401px><div class=img-container style=padding-top:21.945137157107231920199501250%><p class=img-container-inner><img src="" class=img-fluid data-src=/55200a4b0aaaa4dd3cf1115571af818c.png alt="Type-checking support"/></p></div></div><p></p> <p>Module support + static analysis:</p> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\dnscontrol-module-support.png data-real-width=677 data-real-height=213 style=max-width:677px><div class=img-container style=padding-top:31.462333825701624815361890690%><p class=img-container-inner><img src="" class=img-fluid data-src=/ee67e4140139019a932458822d01228e.png alt="Module support"/></p></div></div><p></p> <p>And of couse linting:</p> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\dnscontrol-linting.png data-real-width=432 data-real-height=126 style=max-width:432px><div class=img-container style=padding-top:29.16666666666666666666666667%><p class=img-container-inner><img src="" class=img-fluid data-src=/9538b63a146fa34af704a2b053d63422.png alt="Linting support"/></p></div></div><p></p> <p>Although, to be honest, being able to use Typescript instead of ES5 is always going to make me happy.</p> <h3 id=webpack>Webpack</h3> <p>Now that I also had Webpack support I could do some more advance things like <code>require.context</code>. This means I could bypass DnsControl's rudimentary module loading support in favor of dynamic loading of entire directories. For example:</p> <div class="code-header lang-file"> <span class=language>main.ts</span> <button class=copy data-copy-id=74037ef2a96d40f4b176bf65e037477d> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-file copy-pending"><code data-copy-target=74037ef2a96d40f4b176bf65e037477d class=language-file-main.ts>let context = require.context(&quot;./zones/&quot;, true, /\.ts$/);

context.keys().forEach((zone: string) =&gt; {
    console.log(`Loading ${zone}.`);
    context(zone);
});
</code></pre> <p>This code basically allows me to place all my zones into the <code>zone</code> folder to be dynamically loaded into DnsControl during &quot;compilation&quot; - which is awesome!</p> <h2 id=summary>Summary</h2> <p>DnsControl has this line in their docs:</p> <blockquote class=blockquote> <p>Editing zone files is error-prone.</p> </blockquote> <p>Well, IMHO, writing Javascript is error prone - use Typescript!</p> </main> </div> <div id=comments class=s-comments> <div class=utterances></div> </div> </article> </div> <footer class="text-center s-footer"> <hr> <span> Copyright &copy; Mark Lopez 2021. </span> <span> <a href=/humble-disclaimer/ >Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href=https://creativecommons.org/licenses/by-sa/4.0/ >Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084;</span> by <a href=https://silvenga.com>Silvenga</a>. </span> </footer> <script async defer=defer src=/main.js></script> </body> </html>