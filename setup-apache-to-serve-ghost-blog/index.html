 <!doctype html> <html lang=en-us dir=ltr> <head> <meta charset=utf-8 /> <meta http-equiv=Content-Type content=text/html /> <meta name=HandheldFriendly content=True /> <meta name=viewport content="width=device-width,initial-scale=1"/> <meta name=generator content="Wyam + Webpack"/> <meta name=theme-color content=#000000 /> <title>Setup Apache to Serve Ghost Blogs</title> <meta name=description content="Using Apache as a reverse proxy to service a Ghost instance."> <meta property=og:type content=website> <meta property=og:title content="Setup Apache to Serve Ghost Blogs"> <meta property=og:description content="Using Apache as a reverse proxy to service a Ghost instance."> <meta property=og:locale content=en_US> <meta name=twitter:card content=summary> <meta name=twitter:site content=@Silvenga> <meta name=twitter:creator content=@Silvenga> <link rel=prefetch href=/gist-loader.js> <link rel=prefetch href=/gist-loader> <link rel=preconnect href=https://matomo.silvenga.com> <link rel=preload href=https://matomo.silvenga.com/piwik.js as=script> <link rel=preload href=/main.js as=script> <link rel=stylesheet href=/main.css> </head> <body> <header class="container-fluid s-nav" id=loading-bar role=banner> <nav class="navbar row" role=navigation> <div class="nav col-sm d-flex s-nav-left p-0"> <a class="nav-item nav-link" href=/ > <span class=logo></span> Silvenga's Blog </a> </div> <div class="nav col-sm s-nav-right p-0"> <a class="nav-item nav-link" href=/projects/ >Projects</a> <a class="nav-item nav-link" href=/about/ >About</a> <a class="nav-item nav-link" href=https://github.com/Silvenga aria-label=Github><span class=github></span></a> </div> </nav> </header> <div id=ajax-container> <script type=application/ld+json> {
  "@context" : "http://schema.org",
  "@type" : "Article",
  "headline" : "Setup Apache to Serve Ghost Blogs",
  "datePublished" : "2014-07-11T00:00:00.0000000",
  "dateModified": "2017-12-15T22:42:21.0000000-06:00",
  "author": {
      "name": "Mark Lopez"
  },
  "description": "Using Apache as a reverse proxy to service a Ghost instance."
} </script> <article class="s-content pt-4 m-4 flex-column align-items-stretch"> <div class="flex-column d-flex justify-content-center align-items-center"> <div class=s-title> <h1 class="display-4 text-center">Setup Apache to Serve Ghost Blogs</h1> <div class=text-center> Created on <time datetime=2014-07-11T00:00:00.0000000>July 11, 2014</time>. </div> <div class=text-center> Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/eb92f788>eb92f788</a> on <time datetime=2017-12-15T22:42:21.0000000-06:00>December 15, 2017</time> - 3 total changes. </div> <hr> </div> </div> <div class="justify-content-center mt-2"> <main class="s-article d-flex flex-column align-items-center" role=main> <p>I recently got a request to write a tutorial on how to set up a pre-existing Ghost blog to be served by Apache (the master web server) under the root domain. To add a twist, I will also show how to use Apache as a caching server for the static content of Ghost.</p> <p>For this tutorial I assume the use of Apache 2.2 running on Ubuntu 12.04 LTS. I also assume a basic knowledge of Ubuntu and Apache. Let's start!</p> <p>Lets start of with a clean slate. I personally make sure all my packages are updated and current. Good practice and can prevent issues in the future.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=b3c75ac50f5c493d8c9e2c8e92459aca> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=b3c75ac50f5c493d8c9e2c8e92459aca class=language-bash>sudo apt-get update
sudo apt-get upgrade
sudo apt-get autoremove
</code></pre> <p>Now we are going to need to activate some Apache modules. These should be install (not enabled) by default.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=cba6d22d89b046d3bf07e79654278d20> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=cba6d22d89b046d3bf07e79654278d20 class=language-bash># Enable to mods if not already enabled
# We use a2enmod as the modern way to enable mods (as opposed to creating symlinks)
sudo a2enmod cache disk_cache rewrite proxy proxy_balancer proxy_http

# Restart apache after any mod changes
sudo service apache2 restart 
</code></pre> <p>The mod <code>cache</code> provides the basic framework for any type of caching and does very little on its own. I enabled <code>disk_cache</code> to provide local caching on the disk (we could instead use <code>mem_cache</code> for RAM caching, although I do not recommend this). The mods <code>proxy</code> and <code>proxy_balancer</code> provide the ability to route or proxy requests from Apache to Ghost (Node.js). The mod <code>rewrite</code> will help us streamline the use of <code>proxy</code> and <code>proxy_balancer</code>.</p> <p>Now lets find what ports Ghost is using. I would use this command if I wasn't sure what port to check.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=a7e24cc374b84327884a7bb00a326113> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=a7e24cc374b84327884a7bb00a326113 class=language-bash>sudo netstat -tlpn | grep node
</code></pre> <p>For me this returns two programs that use Node.js:</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=eabc41fff53541d7b08d5c7a5e86ae9e> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=eabc41fff53541d7b08d5c7a5e86ae9e class=language-bash># netstat -tlpn | grep node
tcp  0  0  127.0.0.1:2368  0.0.0.0:*  LISTEN  1275/node
tcp  0  0  127.0.0.1:6633  0.0.0.0:*  LISTEN  1252/node
</code></pre> <p>The default port for production Ghost is <code>2368</code> so the first one looks correct. I personally know that port <code>6633</code> is from my Simple::Whois server. When we proxy request in apache we will direct the requests to port <code>2368</code> on the interface <code>127.0.0.1</code> (or localhost).</p> <p>Lets get configuring Apache. Now there are many ways to do this. I personally like to keep a list of virtual hosts in one file. Although this is against industry standards, I find this approach prevents my renoun forgetfulness.</p> <p>If this file does not already exist, lets create a <code>vhost.conf</code> file.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=488d8f9a38be4d25ba88c2ee0e17eee6> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=488d8f9a38be4d25ba88c2ee0e17eee6 class=language-bash>cd /etc/apache2
sudo touch vhosts.conf # We like touching files
nano vhosts.conf # or your favorite text editor (you vi guys...)
</code></pre> <p>Copy and paste the following, I'll explain it next.</p> <div class="code-header lang-file"> <span class=language>/etc/apache2/vhosts.conf</span> <button class=copy data-copy-id=6d58efd7ebb54a74a4e27209556adc9a> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-file copy-pending"><code data-copy-target=6d58efd7ebb54a74a4e27209556adc9a class=language-file-/etc/apache2/vhosts.conf>&lt;VirtualHost *:80&gt;

	ServerName			silvenga.com	
	ServerAlias 		www.silvenga.com
	DocumentRoot 		/var/www/ghost/public

	RewriteEngine 		on
	RewriteCond 		%{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
	RewriteRule 		^/(.*)$ balancer://upstream%{REQUEST_URI} [P,QSA,L]

	&lt;Proxy balancer://upstream&gt;
		BalancerMember 	http://127.0.0.1:2368
	&lt;/Proxy&gt;

&lt;/VirtualHost&gt;

CacheRoot				/var/www/cache
CacheEnable			  disk	 /
</code></pre> <p>In Apache we use <code>VirtualHost</code> for each &quot;virtual server&quot;. This allows one Apache server to serve multiple domains at the same time. For simplicity we will create a virtual server for our Ghost blog.</p> <p>The <code>ServerName</code> directive should be set to your domain. In my case my domain is <code>silvenga.com</code>. I provide aliasing of the common <code>www</code> subdomain with <code>ServerAlias</code>. <em>These should be changed.</em></p> <p><code>DocumentRoot</code> should be set to some public directly. In my Ghost installation folder (<code>/var/www/ghost</code>) I have a folder called public - containing non-ghost files (e.g. <code>robots.txt</code>, <code>sitemap.xml</code>, etc.). Set this to a good location. Wherever Ghost is install is recommended.</p> <p><code>RewriteEngine</code> enables direct rewriting of the request URL. This allows us to use <code>RewriteCond</code> and <code>RewriteRule</code>. This is where Apache gets tricky and these lines are commonly &quot;copy and pasted&quot;. These two lines basically redirect (or rewrite) requests that do not exist in the <code>/ghost/public</code> to our proxy server. You should not need to change this. I would take a look at the <a href=https://httpd.apache.org/docs/2.2/mod/mod_rewrite.html>official documentation</a> for more info.</p> <p>The <code>Proxy</code> directive specifies a list of services to proxy too. We only have one server (ghost). We add that here. If Ghost's port is different, this is the place to assert that. More info can be found <a href=https://httpd.apache.org/docs/2.2/mod/mod_proxy_balancer.html>here</a>.</p> <p>For disk caching we need to specify a local location for the cache (<code>CacheRoot</code>). I personally use <code>/var/www/cache</code>. <code>CacheEnable</code> enables disk caching for any address that starts with <code>/</code> - basically any and all requests. I will use <code>/var/www/cache</code> for this tutorial.</p> <p>After we have this we need to tell Apache there is a unorthodox configuration file.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=484346c9ca9041758ff0c1339778f628> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=484346c9ca9041758ff0c1339778f628 class=language-bash>cd /etc/apache2
# Open Apache's main config. 
nano apache2.conf
</code></pre> <p>And add the following lines:</p> <div class="code-header lang-code"> <span class=language>Code</span> <button class=copy data-copy-id=d5e1fff3e1d047418b941afffea624fb> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-code copy-pending"><code data-copy-target=d5e1fff3e1d047418b941afffea624fb class=language-/etc/apache2/apache2.conf># Virtual hosts
Include /etc/apache2/vhosts.conf
</code></pre> <p>To make sure that Apache can cache to the folder we gave, we should create it and set the correct permissions.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=2a3545ceebc1441286d560bbab35abc8> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=2a3545ceebc1441286d560bbab35abc8 class=language-bash>sudo mkdir /var/www/cache

# I assume the Apache is using the default user &quot;www-data&quot;
sudo chown www-data:www-data /var/www/cache
</code></pre> <p>We should be all good. Let's restart and test out configuration.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=cdd18702118a49948362fa6255cd1ba9> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=cdd18702118a49948362fa6255cd1ba9 class=language-bash>sudo service apache2 restart
</code></pre> <p>Done! Lets take a look and see if Apache is working correctly. Goto your domain listed in the <code>vhost.conf</code> file on the default port 80.</p> <blockquote class=blockquote> <p>Update: Forgot the <code>mod_proxy_http</code> to provide <code>mod_proxy_balancer</code> support for HTTP. Thanks <a href=http://jensencloud.com>Jon</a>!</p> </blockquote> </main> </div> <div id=comments class=s-comments> <div class=utterances></div> </div> </article> </div> <footer class="text-center s-footer"> <hr> <span> Copyright &copy; Mark Lopez 2019. </span> <span> <a href=/humble-disclaimer/ >Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href=https://creativecommons.org/licenses/by-sa/4.0/ >Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084;</span> by <a href=https://silvenga.com>Silvenga</a>. </span> </footer> <script async defer=defer src=/main.js></script> </body> </html>