 <!DOCTYPE html> <html lang=en-us dir=ltr> <head> <meta charset=utf-8 /> <meta http-equiv=Content-Type content=text/html /> <meta name=HandheldFriendly content=True /> <meta name=viewport content="width=device-width,initial-scale=1"/> <meta name=generator content="Wyam + Webpack"/> <meta name=theme-color content=#000000 /> <title>Deploy a Tinc Mesh VPN Running TAP</title> <meta name=description content="Yet another how-to on setting up a mesh network using Tinc (in TAP mode)."> <meta property=og:type content=website> <meta property=og:title content="Deploy a Tinc Mesh VPN Running TAP"> <meta property=og:description content="Yet another how-to on setting up a mesh network using Tinc (in TAP mode)."> <meta property=og:locale content=en_US> <meta name=twitter:card content=summary> <meta name=twitter:site content=@Silvenga> <meta name=twitter:creator content=@Silvenga> <link rel=prefetch href=/gist-loader.js> <link rel=prefetch href=/gist-loader> <link rel=preconnect href=https://piwik.silvenga.com> <link rel=preload href=https://piwik.silvenga.com/piwik.js as=script> <link rel=preload href=/main.js as=script> <link rel=stylesheet href=/main.css> </head> <body> <header class="container-fluid s-nav" id=loading-bar role=banner> <nav class="navbar row" role=navigation> <div class="nav col-sm d-flex s-nav-left p-0"> <a class="nav-item nav-link" href=/ > <span class=logo></span> Silvenga's Blog <sub>(beta)</sub> </a> </div> <div class="nav col-sm s-nav-right p-0"> <a class="nav-item nav-link" href=/projects/ >Projects</a> <a class="nav-item nav-link" href=/about/ >About</a> <a class="nav-item nav-link" href=https://github.com/Silvenga aria-label=Github><span class=github></span></a> </div> </nav> </header> <div id=ajax-container> <script type=application/ld+json> {
  "@context" : "http://schema.org",
  "@type" : "Article",
  "headline" : "Deploy a Tinc Mesh VPN Running TAP",
  "datePublished" : "2014-07-25T00:00:00.0000000",
  "dateModified": "2017-12-15T22:42:21.0000000-06:00",
  "author": {
      "name": "Mark Lopez"
  },
  "description": "Yet another how-to on setting up a mesh network using Tinc (in TAP mode)."
} </script> <article class="s-content pt-4 m-4 flex-column align-items-stretch"> <div class="flex-column d-flex justify-content-center align-items-center"> <div class=s-title> <h1 class="display-4 text-center">Deploy a Tinc Mesh VPN Running TAP</h1> <div class=text-center> Created on <time datetime=2014-07-25T00:00:00.0000000>July 25, 2014</time>. </div> <div class=text-center> Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/eb92f788>eb92f788</a> on <time datetime=2017-12-15T22:42:21.0000000-06:00>December 15, 2017</time> - 5 total changes. </div> <hr> </div> </div> <div class="justify-content-center mt-2"> <main class="s-article d-flex flex-column align-items-center" role=main> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2014\Jul\generalMesh.gif data-real-width=1500 data-real-height=660 style=max-width:780px><div class=img-container style=padding-top:44%><p class=img-container-inner><img src="" class=img-fluid data-src=/0d09ecc0d820790486eb66065936dd99.gif alt="Mesh Network"/></p></div></div><p></p> <p>I've used OpenVPN for several years now. The software is secure, stable, and has a great community - a prime example of Open Source at its best. OpenVPN is easily the best VPN software available. However, I recently moved to Tinc an Open Source alternative VPN. If OpenVPN was working great, why would I change to a completely new network?</p> <p>The answer is amazingly simple - Tinc is a mesh network. I have servers across the United States - each one connected through this private network. With OpenVPN I would have to pass requests from one server to another through the OpenVPN master server.</p> <p>This sucks. Imagine if the OpenVPN server is in Florida, the two servers who want to talk to each other are located in California. These two servers have less than 1ms latency between them, but to chat they need to send their bits from California through 2,661 miles of (hopefully) glass, to Florida, and then back. If this journey takes 600 ms, that is an 599 ms overhead.</p> <p>Tinc solves this problem by using the mesh network strategy. In a mesh network, every node (rather than just the server and client) can relay traffic. Each node attempt direct connections to chat with one another. So instead of that 600ms round trip, I can hit &lt; 1ms - a 600% improvement. If thats not a good reason, I don't know what is.</p> <p>In my small network (less than 20 nodes) Tinc is a perfect replacement to OpenVPN. Tinc provides the same security, the same TAP connections, is cross platform (Mac, Linux, Windows, Android), and is pretty stable (no issues so far). Although the documentation is rather lacking (took me a while to compile this tutorial).</p> <p>Interesting note, Tinc is lighter than OpenVPN and soooo much easier to configure, go figure...</p> <h2 id=setting-up-tinc>Setting Up Tinc</h2> <p>This setup process will provide everything you need to setup Tinc using TAP. I assume the reader is using Ubuntu 14.04 LTS.</p> <p>I'm going to have two servers in this post - Obama and Mccain. They want to talk directly with each other. Neither will be the only a server, or only a client, both will be an equal peer.</p> <p>To install Tinc I recommend getting the latest version. Right now Ubuntu is lagging behind, so I need to get the latest version though a <code>.deb</code>. The following uses 32-bit tinc. If you're running 64-bit use: (<a href=http://mirrors.kernel.org/ubuntu/pool/universe/t/tinc/tinc_1.0.24-2.1_amd64.deb>http://mirrors.kernel.org/ubuntu/pool/universe/t/tinc/tinc_1.0.24-2.1_amd64.deb</a>).</p> <p>If you can't find the correct packages from Ubuntu's Repo's checkout Debain's. Most of these will work without issues.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=7a51dce03a4c47c4ba7231deec17ce30> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=7a51dce03a4c47c4ba7231deec17ce30 class=language-bash># I like a clean workspace
cd /tmp

# The latest as of 7-25 is version 1.0.24. This is from an upstream build from 14.10. 
# Tinc has almost no dependencies, and is safe to install from upstream
wget http://launchpadlibrarian.net/179504313/tinc_1.0.24-2.1_i386.deb

# Install the package via dpkg
sudo dpkg -i tinc_1.0*.deb

# Fix any dependencies
apt-get install -f

# Clean up
rm tinc_1.0.24-2.1_i386.deb
</code></pre> <p>We should be good with the install. Do this for both servers.</p> <h2 id=configure-tinc>Configure Tinc</h2> <p>First we need a &quot;network name&quot;, this name separates nodes, and allows for multiple networks on the same network. In this tutorial I will call the network <code>master</code>, anywhere you see <code>master</code> here just change the name to what you decided.</p> <p>First we need to create a &quot;network&quot; configuration directory. For Tinc this is done by creating a folder in <code>/etc/tinc/</code>.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=7907fc22755b48c28c469e30e149292f> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=7907fc22755b48c28c469e30e149292f class=language-bash>cd /etc/tinc
sudo mkdir master
sudo mkdir master/hosts
cd ./master
</code></pre> <p>Each node must have at least two files, and an optional third - <code>tinc.conf</code>, <code>tinc-up</code>, and <code>tinc-down</code>, respectively. Lets make those now on each node.</p> <h4 id=tinc.conf>tinc.conf</h4> <div class="code-header lang-code"> <span class=language>Code</span> <button class=copy data-copy-id=ad6360318dcc459c94ea6b1cfc34be76> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-code copy-pending"><code data-copy-target=ad6360318dcc459c94ea6b1cfc34be76># The name of the node, must be unique for the network 
Name = obama

# We live in modern dual stack IPv4/IPv6 times, use any
AddressFamily = any

# So we can use TAP
Device = /dev/net/tun

# Puts Tinc into TAP mode, also sets up routing tables
Mode = switch

# To what nodes should Tinc attempt to connect to
ConnectTo = mccain
#ConnectTo = obama
#ConnectTo = george
#ConnectTo = tom
#ConnectTo = henery
</code></pre> <p>This one is for Obama, make sure to <code>name</code> the other server differently (Mccain).</p> <h4 id=tinc-up>tinc-up</h4> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=8931d0aa49bf4c4c8766878bf1bcd6aa> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=8931d0aa49bf4c4c8766878bf1bcd6aa class=language-bash>#!/bin/sh 
ifconfig $INTERFACE 10.6.0.1 netmask 255.255.0.0
</code></pre> <p>Obama will have <code>10.6.0.1</code> as its address. Setup Mccain to something different (<code>10.6.0.2</code> would work). Make sure to include <code>#!/bin/sh</code>, else Tinc might have issues.</p> <h4 id=tinc-down>tinc-down</h4> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=c7f9b3d513784b21baf242fb6d285942> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=c7f9b3d513784b21baf242fb6d285942 class=language-bash>#!/bin/sh 
ifconfig $INTERFACE down
</code></pre> <p>Although not strictly required, this allows us to clean up after we shut down Tinc.</p> <p>We need to allow Tinc to execute these last two files.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=82dace7d724a4beab55b84c005cada31> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=82dace7d724a4beab55b84c005cada31 class=language-bash>sudo chmod +x tinc-*
</code></pre> <p>Now we need to make host files. These files point Tinc to each other, and allows direct connections. These files are safe and required to share around.</p> <p>Each node needs to make this locally. The format is simple. Name the host file after the local name give in the tinc.conf file.</p> <h4 id=hostsobama>hosts/obama</h4> <div class="code-header lang-code"> <span class=language>Code</span> <button class=copy data-copy-id=d2cad60e5e524357991d123f9dc74b35> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-code copy-pending"><code data-copy-target=d2cad60e5e524357991d123f9dc74b35>Address = obama.example.com
Subnet = 10.0.0.0/16
</code></pre> <p>That's all that is required in TAP switch mode. Routes are discovered automatically. <code>Address</code> tells Tinc where to look, luckily we can use a DNS name or IP address. <code>Subnet</code> tells Tinc where to automatically discover and is not strictly required. If you use a subnet, make sure that it's correct.</p> <p>Final step here is to generate private keys for every peer. On each node run this command to automatically do this. The <code>-k</code> generates the key for the local peer in the <code>master</code> network.</p> <div class="code-header lang-code"> <span class=language>Code</span> <button class=copy data-copy-id=25fdce34fbbe4a86a1e1949aa6e95474> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-code copy-pending"><code data-copy-target=25fdce34fbbe4a86a1e1949aa6e95474>sudo tincd -n master -K
</code></pre> <p>After generating keys, make sure to share the updated host file for the local node. Take a look in it and you're see a public key directive was added by <code>tincd</code>. This allows nodes to authenticate each other with math! (I always get a kickout of that)</p> <h2 id=running-tinc>Running Tinc</h2> <p>After we share the host files around we can start Tinc.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=cacd9a8471de4b5aa2835a166ac9a840> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=cacd9a8471de4b5aa2835a166ac9a840 class=language-bash>sudo tincd -n master
</code></pre> <p><code>-n &lt;network name&gt;</code> is used to specify a particular (you can multiple networks on the same server).</p> <p>To kill Tinc use <code>-k</code>.</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=b72b9740ec4d445eb8130f709dee9d7d> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=b72b9740ec4d445eb8130f709dee9d7d class=language-bash>sudo tincd -n master -k
</code></pre> <p>If there are no issues we can set Tinc to run on startup (and to obey the service commands).</p> <p>Simple command:</p> <div class="code-header lang-bash"> <span class=language>Bash</span> <button class=copy data-copy-id=7038775e071342498959c5f30c7a4e1f> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-bash copy-pending"><code data-copy-target=7038775e071342498959c5f30c7a4e1f class=language-bash>sudo echo &quot;master&quot; &gt;&gt; nets.boot
</code></pre> <p>Now we can use: <code>sudo service tincd restart</code></p> <p>At this point we should have two servers talking to each other over Tinc. No more need for a middleman server.</p> <blockquote class=blockquote> <p>Update: Forgot the ConnectTo directive.</p> </blockquote> </main> </div> </article> </div> <footer class="text-center s-footer"> <hr> <span> Copyright &copy; Mark Lopez 2018. </span> <span> <a href=/humble-disclaimer/ >Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href=https://creativecommons.org/licenses/by-sa/4.0/ >Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084;</span> by <a href=https://silvenga.com>Silvenga</a>. </span> </footer> <script async defer=defer src=/main.js></script> </body> </html>