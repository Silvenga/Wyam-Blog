<!DOCTYPE html><html><head><title>Silvenga</title><meta http-equiv=content-language content=en-us><meta http-equiv=Content-Type content=text/html charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=HandheldFriendly content=True><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=generator content=Wyam><link rel=stylesheet href=/min.css></head><body><header class=header><div class=fade><h1><a href="/">Silvenga</a></h1><p>Just another Weblog for the masses.</p></div></header><div id=ajax-container><div id=ajax-content><main class=content><nav class=nav-bar><div class=nav-container><div class="nav-text lefted"><a class=h3 href="//"> Browse Posts </a> <a class=h3 href="/projects/"> My Projects </a> <a class=h3 href="/about/"> About Me </a></div><div class="nav-icons righted"><a href=https://twitter.com/Silvenga><div class=icon-container><div class=icon-twitter></div></div></a> <a href=https://www.linkedin.com/in/silvenga><div class=icon-container><div class=icon-linkedin></div></div></a> <a href=https://github.com/Silvenga><div class=icon-container><div class=icon-github></div></div></a></div></div></nav><div class=body><article class=article><div class=main-container><div class=article-header><h1 class=article-title>Ceph Feature Missmatch with Kubernetes</h1><div class=article-date>October 04, 2017 <span class="right article-git"> Commit <a href=https://github.com/Silvenga/silvenga.com/commit/1bcf2963>1BCF2963</a> from 10-04-2017 - 1 edit total </span></div></div><div class=article-container><div class="article-content flow"><p>I needed a better backing storage system for my Kubernetes cluster - I am done with NFS (so many problems). In the end I decided I'll go for a Ceph cluster after being rather impressed by the feature set.</p><p>So I got a Luminous Ceph cluster deployed and everything was working (after fighting with the beta external storage features, no more custom Kube Controllers, yay!). Then I tried to actually get a test deployment up, but I kept on seeing the following errors on my nodes:</p><pre><code>libceph: mon0 172.16.0.104:6789 feature set mismatch, my 106b84a842a42 &lt; server's 40106b84a842a42, missing 400000000000000
</code></pre><p>I originally thought it was due to running Luminous (the ceph provisioner that I was using targeted Jewel) so I created my own image with Luminous binaries. Same message as before, no change from what I could tell. My next idea was the image format was to new (stupid thought in retrospective, <em>shrug</em>). No change on that error message.</p><p>Looking deeper into the error message (which I should have done before). This error occurred from a monitor after image construction, but before image mount. The error was complaining that the feature flag <code>400000000000000</code> was missing support by my client. This feature turns out to mean basically <code>CRUSH_TUNABLES5</code> with the following requirements (Google is great at this):</p><pre><code>v10.0.2 (jewel) or later
Linux kernel version v4.5 or later (for the file system and RBD kernel clients)
</code></pre><p>And that's my problem. I'm assuming that Kubernetes is using the kernel module to mount rbd's, but my nodes are running Ubuntu 16.04 with the following kernel:</p><pre><code>4.4.0-96-generic #119-Ubuntu SMP Tue Sep 12 14:59:54 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
</code></pre><p>This leaves me with 3 options to fix this:</p><ul><li>Upgrade the kernel (I rather not)</li><li>Get Kubernetes to not use kernel rbd (not sure where to even start)</li><li>Update the feature flags to not require flag <code>400000000000000</code></li></ul><p>Turns out the last one is really easy to do, Ceph really is enterprise ready. Running the following on a node finally got my image to mount within a pod.</p><pre><code>ceph osd crush tunables hammer
</code></pre><p>Hammer (<code>CRUSH_V4</code>) being the version of CRUSH before Jewel (<code>CRUSH_TUNABLES5</code>).</p><p><a href=http://docs.ceph.com/docs/master/rados/operations/crush-map>http://docs.ceph.com/docs/master/rados/operations/crush-map</a></p></div></div></div></article></div><div class="hidden full-width"><div id=title>Silvenga</div><div id=page-id>post.id</div><div id=page-width></div></div></main><footer class=footer id=main-footer><div class=footer-wrapper><div class=footer-container>Copyright &copy; Mark Lopez 2017. <a href="/humble-disclaimer/">My Humble Disclaimer and Privacy Policy</a>.<br>Written under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. <br> Generated on 10/7/2017 3:58:49 PM &#x2B;00:00 using Wyam. <br> Made with <span class=heart>&#10084</span> by <a href=https://silvenga.com>Silvenga</a>.</div></div></footer></div></div><script async defer src=/min.js></script></body></html>