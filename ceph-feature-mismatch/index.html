<!DOCTYPE html><html><head><title>Ceph Feature Missmatch with Kubernetes</title><meta http-equiv=content-language content=en-us><meta http-equiv=Content-Type content=text/html charset=UTF-8><meta name=HandheldFriendly content=True><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=generator content=Wyam><link rel=stylesheet href=/main.css></head><body><header class="container-fluid s-nav"><nav class="navbar row"><div class="nav col-sm d-flex s-nav-left p-0"><a class="nav-item nav-link" href="/">Silvenga's Blog <sub>(beta)</sub></a></div><div class="nav col-sm s-nav-right p-0"><a class="nav-item nav-link" href="/projects/">Projects</a> <a class="nav-item nav-link" href="/about/">About</a></div></nav></header><div id=ajax-container><article class="s-content pt-4 m-4 flex-column align-items-stretch"><div class="flex-column d-flex justify-content-center align-items-center"><div class=s-title><h2 class="display-4 text-center">Ceph Feature Missmatch with Kubernetes</h2><div class=text-center>Created on <date>October 04, 2017</date>.</div><div class=text-center>Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/850f897b>850f897b</a> on <date>November 26, 2017</date> - 2 total changes.</div><hr></div></div><div class="justify-content-center mt-2"><div class="s-article d-flex flex-column align-items-center"><figure class=figure><p><img src=/content/images/2017/kubernetes-plus-ceph.png class=img-fluid alt=""></p><figcaption class=figure-caption>Source: <a href="https://habrahabr.ru/company/flant/blog/329666/">habrahabr.ru</a></figcaption></figure><p>I needed a better backing storage system for my Kubernetes cluster - I am done with NFS (so many problems). In the end I decided I'll go for a Ceph cluster after being rather impressed by the feature set.</p><p>So I got a Luminous Ceph cluster deployed and everything was working (after fighting with the beta external storage features, no more custom Kube Controllers, yay!). Then I tried to actually get a test deployment up, but I kept on seeing the following errors on my nodes:</p><pre><code>libceph: mon0 172.16.0.104:6789 feature set mismatch, my 106b84a842a42 &lt; server's 40106b84a842a42, missing 400000000000000
</code></pre><p>I originally thought it was due to running Luminous (the ceph provisioner that I was using targeted Jewel) so I created my own image with Luminous binaries. Same message as before, no change from what I could tell. My next idea was the image format was to new (stupid thought in retrospective, <em>shrug</em>). No change on that error message.</p><p>Looking deeper into the error message (which I should have done before). This error occurred from a monitor after image construction, but before image mount. The error was complaining that the feature flag <code>400000000000000</code> was missing support by my client. This feature turns out to mean basically <code>CRUSH_TUNABLES5</code> with the following requirements (Google is great at this):</p><pre><code>v10.0.2 (jewel) or later
Linux kernel version v4.5 or later (for the file system and RBD kernel clients)
</code></pre><p>And that's my problem. I'm assuming that Kubernetes is using the kernel module to mount rbd's, but my nodes are running Ubuntu 16.04 with the following kernel:</p><pre><code>4.4.0-96-generic #119-Ubuntu SMP Tue Sep 12 14:59:54 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
</code></pre><p>This leaves me with 3 options to fix this:</p><ul><li>Upgrade the kernel (I rather not)</li><li>Get Kubernetes to not use kernel rbd (not sure where to even start)</li><li>Update the feature flags to not require flag <code>400000000000000</code></li></ul><p>Turns out the last one is really easy to do, Ceph really is enterprise ready. Running the following on a node finally got my image to mount within a pod.</p><pre><code>ceph osd crush tunables hammer
</code></pre><p>Hammer (<code>CRUSH_V4</code>) being the version of CRUSH before Jewel (<code>CRUSH_TUNABLES5</code>).</p><p><a href=http://docs.ceph.com/docs/master/rados/operations/crush-map>http://docs.ceph.com/docs/master/rados/operations/crush-map</a></p></div></div></article></div><footer class="text-center s-footer"><hr><span> Copyright &copy; Mark Lopez 2017. </span> <span> <a href="/humble-disclaimer/">Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084</span> by <a href=https://silvenga.com>Silvenga</a>. </span></footer><script async defer src=/main.js></script></body></html>