<!DOCTYPE html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=Content-Type content=text/html><meta name=HandheldFriendly content=True><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=generator content="Wyam + Webpack"><title>Ceph Feature Missmatch with Kubernetes</title><meta name=description content="Getting Ceph to place nice with Kubernetes."><meta property=og:type content=website><meta property=og:title content="Ceph Feature Missmatch with Kubernetes"><meta property=og:description content="Getting Ceph to place nice with Kubernetes."><meta property=og:locale content=en_US><meta name=twitter:card content=summary><meta name=twitter:site content=@Silvenga><meta name=twitter:creator content=@Silvenga><link rel=prefetch href=/gist-loader.js><link rel=prefetch href=/gist-loader><link rel=preconnect href=https://piwik.silvenga.com><link rel=preload href=https://piwik.silvenga.com/piwik.js as=script><link rel=preload href=/main.js as=script><link rel=stylesheet href=/main.css></head><body><header class="container-fluid s-nav" id=loading-bar role=banner><nav class="navbar row" role=navigation><div class="nav col-sm d-flex s-nav-left p-0"><a class="nav-item nav-link" href="/"> <span class=logo></span> Silvenga's Blog <sub>(beta)</sub> </a></div><div class="nav col-sm s-nav-right p-0"><a class="nav-item nav-link" href="/projects/">Projects</a> <a class="nav-item nav-link" href="/about/">About</a></div></nav></header><div id=ajax-container><script type=application/ld+json>
{
  "@context" : "http://schema.org",
  "@type" : "Article",
  "headline" : "Ceph Feature Missmatch with Kubernetes",
  "datePublished" : "2017-10-04T21:50:00.0000000",
  "dateModified": "2017-12-16T12:54:05.0000000-06:00",
  "author": {
      "name": "Mark Lopez"
  },
  "description": "Getting Ceph to place nice with Kubernetes."
}
</script><article class="s-content pt-4 m-4 flex-column align-items-stretch"><div class="flex-column d-flex justify-content-center align-items-center"><div class=s-title><h1 class="display-4 text-center">Ceph Feature Missmatch with Kubernetes</h1><div class=text-center>Created on <time datetime=2017-10-04T21:50:00.0000000>October 04, 2017</time>.</div><div class=text-center>Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/8a9e7b67>8a9e7b67</a> on <time datetime=2017-12-16T12:54:05.0000000-06:00>December 16, 2017</time> - 6 total changes.</div><hr></div></div><div class="justify-content-center mt-2"><main class="s-article d-flex flex-column align-items-center" role=main><figure class=figure><p><img src=/content/images/2017/kubernetes-plus-ceph.png class=img-fluid data-real-path=C:\projects\silvenga-com\input\posts\content\images\2017\kubernetes-plus-ceph.png height=480 width=980 alt="Kubernetes + Ceph"></p><figcaption class=figure-caption>Source: <a href="https://habrahabr.ru/company/flant/blog/329666/">habrahabr.ru</a></figcaption></figure><p>I needed a better backing storage system for my Kubernetes cluster - I am done with NFS (so many problems). In the end I decided I'll go for a Ceph cluster after being rather impressed by the feature set.</p><p>So I got a Luminous Ceph cluster deployed and everything was working (after fighting with the beta external storage features, no more custom Kube Controllers, yay!). Then I tried to actually get a test deployment up, but I kept on seeing the following errors on my nodes:</p><div class=code-header><span class=language>Logs</span> <button class=copy data-copy-id=f493811e05cc49efacb4a98411c87a2a> <span>Copy</span> </button></div><pre><code data-copy-target=f493811e05cc49efacb4a98411c87a2a class=language-log>libceph: mon0 172.16.0.104:6789 feature set mismatch, my 106b84a842a42 &lt; server's 40106b84a842a42, missing 400000000000000
</code></pre><p>I originally thought it was due to running Luminous (the ceph provisioner that I was using targeted Jewel) so I created my own image with Luminous binaries. Same message as before, no change from what I could tell. My next idea was the image format was to new (stupid thought in retrospective, <em>shrug</em>). No change on that error message.</p><p>Looking deeper into the error message (which I should have done before). This error occurred from a monitor after image construction, but before image mount. The error was complaining that the feature flag <code>400000000000000</code> was missing support by my client. This feature turns out to mean basically <code>CRUSH_TUNABLES5</code> with the following requirements (Google is great at this):</p><div class=code-header><span class=language>Code</span> <button class=copy data-copy-id=9339692318314ebcb09de695cfc528ad> <span>Copy</span> </button></div><pre><code data-copy-target=9339692318314ebcb09de695cfc528ad>v10.0.2 (jewel) or later
Linux kernel version v4.5 or later (for the file system and RBD kernel clients)
</code></pre><p>And that's my problem. I'm assuming that Kubernetes is using the kernel module to mount rbd's, but my nodes are running Ubuntu 16.04 with the following kernel:</p><div class=code-header><span class=language>Code</span> <button class=copy data-copy-id=7ffd89fd2ab943ef87dda42258c4e7ac> <span>Copy</span> </button></div><pre><code data-copy-target=7ffd89fd2ab943ef87dda42258c4e7ac>4.4.0-96-generic #119-Ubuntu SMP Tue Sep 12 14:59:54 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
</code></pre><p>This leaves me with 3 options to fix this:</p><ul><li>Upgrade the kernel (I rather not)</li><li>Get Kubernetes to not use kernel rbd (not sure where to even start)</li><li>Update the feature flags to not require flag <code>400000000000000</code></li></ul><p>Turns out the last one is really easy to do, Ceph really is enterprise ready. Running the following on a node finally got my image to mount within a pod.</p><div class=code-header><span class=language>Bash</span> <button class=copy data-copy-id=f2e78170af74459eae4786213ad7b501> <span>Copy</span> </button></div><pre><code data-copy-target=f2e78170af74459eae4786213ad7b501 class=language-bash>ceph osd crush tunables hammer
</code></pre><p>Hammer (<code>CRUSH_V4</code>) being the version of CRUSH before Jewel (<code>CRUSH_TUNABLES5</code>).</p><p><a href=http://docs.ceph.com/docs/master/rados/operations/crush-map>http://docs.ceph.com/docs/master/rados/operations/crush-map</a></p></main></div></article></div><footer class="text-center s-footer"><hr><span> Copyright &copy; Mark Lopez 2018. </span> <span> <a href="/humble-disclaimer/">Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084;</span> by <a href=https://silvenga.com>Silvenga</a>. </span></footer><script async defer src=/main.js></script></body></html>