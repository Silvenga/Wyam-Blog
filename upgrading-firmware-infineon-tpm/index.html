 <!doctype html> <html lang=en-us dir=ltr> <head> <meta charset=utf-8 /> <meta http-equiv=Content-Type content=text/html /> <meta name=HandheldFriendly content=True /> <meta name=viewport content="width=device-width,initial-scale=1"/> <meta name=generator content="Wyam + Webpack"/> <meta name=theme-color content=#000000 /> <title>Upgrading the Firmware on Infineon TPM&#x27;s</title> <meta name=description content="Upgrading the Infineon TPM firmware on Asus (and friends) motherboards."> <meta property=og:type content=website> <meta property=og:title content="Upgrading the Firmware on Infineon TPM&#x27;s"> <meta property=og:description content="Upgrading the Infineon TPM firmware on Asus (and friends) motherboards."> <meta property=og:locale content=en_US> <meta name=twitter:card content=summary> <meta name=twitter:site content=@Silvenga> <meta name=twitter:creator content=@Silvenga> <link rel=prefetch href=/gist-loader.js> <link rel=prefetch href=/gist-loader> <link rel=preconnect href=https://matomo.silvenga.com> <link rel=preload href=https://matomo.silvenga.com/piwik.js as=script> <link rel=preload href=/main.js as=script> <link rel=stylesheet href=/main.css> </head> <body> <header class="container-fluid s-nav" id=loading-bar role=banner> <nav class="navbar row" role=navigation> <div class="nav col-sm d-flex s-nav-left p-0"> <a class="nav-item nav-link" href=/ > <span class=logo></span> Silvenga's Blog </a> </div> <div class="nav col-sm s-nav-right p-0"> <a class="nav-item nav-link" href=/projects/ >Projects</a> <a class="nav-item nav-link" href=/about/ >About</a> <a class="nav-item nav-link" href=https://github.com/Silvenga aria-label=Github><span class=github></span></a> </div> </nav> </header> <div id=ajax-container> <script type=application/ld+json> {
  "@context" : "http://schema.org",
  "@type" : "Article",
  "headline" : "Upgrading the Firmware on Infineon TPM&#x27;s",
  "datePublished" : "2018-04-14T00:00:00.0000000",
  "dateModified": "2020-02-26T19:41:35.0000000-06:00",
  "author": {
      "name": "Mark Lopez"
  },
  "description": "Upgrading the Infineon TPM firmware on Asus (and friends) motherboards."
} </script> <article class="s-content pt-4 m-4 flex-column align-items-stretch"> <div class="flex-column d-flex justify-content-center align-items-center"> <div class=s-title> <h1 class="display-4 text-center">Upgrading the Firmware on Infineon TPM&#x27;s</h1> <div class=text-center> Created on <time datetime=2018-04-14T00:00:00.0000000>April 14, 2018</time>. </div> <div class=text-center> Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/969107a1>969107a1</a> on <time datetime=2020-02-26T19:41:35.0000000-06:00>February 26, 2020</time> - 4 total changes. </div> <hr> </div> </div> <div class="justify-content-center mt-2"> <main class="s-article d-flex flex-column align-items-center" role=main> <p>In early October of 2017, researchers announced, publicly, a cryptographic vulnerability in the RSA generation algorithms found within practically every TPM, using Infineon's RSA library. This vulnerability would effectively allow an attacker to easily guess the private key component of the RSA key stored within the TPM - rendering the protections and insurances granted by the TPM useless. Turns out, many TPM's actually use Infineon's technologies, meaning many TPM's are vulnerability - including all Asus and Gigabyte TPM's (that I know of).</p> <blockquote class=blockquote> <p>tl;dr - TPM broke, I sad, TPM need fix.</p> </blockquote> <p>Since the point of TPM's is to perform key protection inside hardware, a software fix is impossible. This is so difficult to mitigate that Window's just resorts to emitting a warning in the Event Logs like the one below:</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=6c35cf77e1144187924404b43b8143af> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=6c35cf77e1144187924404b43b8143af class=language-ps1>Get-EventLog -LogName System -Source Microsoft-Windows-TPM-WMI -EntryType Error | select Message
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=af6bada9b6254167a7b00394797c487b> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=af6bada9b6254167a7b00394797c487b class=language-output>The Trusted Platform Module (TPM) firmware on this PC has a known security problem. 
Please contact your PC manufacturer to find out if an update is available. 
For more information please go to https://go.microsoft.com/fwlink/?linkid=852572
</code></pre> <p>Now, 6 months later and over a year since Infineon was notified of this issue, Asus and Gigabyte have yet to release updates for their TPM's. Although, I'm not particularly surprised considering most consumers would likely brick their machine's when trying to update (or not need to update to begin with). Thankfully, many enterprise-centered company's use these Infineon based TPM's, meaning we, the consumers, can piggyback off of enterprise clients shouting for a fix.</p> <p>In this case, it turns out that the Asus and Gigabyte TPM's are effectively the same one's found in some Supermicro servers, and of course, Supermicro had to release firmware updates - updates that we can use.</p> <h2 id=getting-started>Getting Started</h2> <p>Before I get started, I want to make sure the TPM is working in my device. I can ask Window's about it via the <code>Get-TPM</code> command.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=9ef31b201ff64fe89604667ee5163908> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=9ef31b201ff64fe89604667ee5163908 class=language-ps1>Get-Tpm
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=6a2dd26b5f5b42aa9d4c9676712bc70a> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=6a2dd26b5f5b42aa9d4c9676712bc70a class=language-output>TpmPresent          : True
TpmReady            : False
ManufacturerId      : 1229346816
ManufacturerVersion : 5.61
ManagedAuthLevel    : Delegated
OwnerAuth           :
OwnerClearDisabled  : True
AutoProvisioning    : Enabled
LockedOut           : False
LockoutCount        : 0
LockoutMax          : 32
SelfTest            : {}
</code></pre> <h2 id=getting-the-firmware>Getting the Firmware</h2> <p>Everything looks good! Now to get the firmware. I found a compatible version on <a href=https://www.supermicro.com/wftp/driver/TPM/ >Supermicro's driver site</a> (<a href=ftp://ftp.supermicro.com/driver/TPM>Driver FTP</a>).</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=ad4c735757c54880a5ad22b62fa7c358> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=ad4c735757c54880a5ad22b62fa7c358 class=language-ps1>Invoke-WebRequest -Uri https://www.supermicro.com/wftp/driver/TPM/9665FW%20update%20package_1.5.zip -OutFile '9665FW update package_1.5.zip' -UseBasicParsing
Expand-Archive '.\9665FW update package_1.5.zip' -DestinationPath .
cd '.\9665FW update package_1.5\'
</code></pre> <p>Looking through the files extracted files, there are two directories:</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=f3d92b91a97c4af89021896ee0377152> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=f3d92b91a97c4af89021896ee0377152 class=language-ps1>ls | select Name
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=4edf0a2e5e484ab8a4523a45c3d7ddb6> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=4edf0a2e5e484ab8a4523a45c3d7ddb6 class=language-output>Firmware
Tools
9665.nsh
Readme.txt
</code></pre> <p>The important files are these:</p> <div class="code-header lang-code"> <span class=language>Code</span> <button class=copy data-copy-id=112c7bee8e384a1bbb2e459123a6fc58> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-code copy-pending"><code data-copy-target=112c7bee8e384a1bbb2e459123a6fc58>Firmware\* &lt;- containing the TPM firmwares.
Tools\WinPE\Bin\x64\TPMFactoryUpd.exe &lt;- The actual updater, for Windows.
</code></pre> <p>I'm going to copy the above to the same folder, because I'm lazy.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=c81601f2e34141759201cee5de35d90f> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=c81601f2e34141759201cee5de35d90f class=language-ps1>mkdir workspace
cp .\Firmware\* .\workspace\
cp .\Tools\WinPE\Bin\x64\* .\workspace\
</code></pre> <p>Now <code>.\workspace</code> contains the following files:</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=40ad975ecb04407ba14b438d1bc743a2> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=40ad975ecb04407ba14b438d1bc743a2 class=language-ps1>ls | select Name
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=68ee349ce7c44d4f8de10c64205a2bbd> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=68ee349ce7c44d4f8de10c64205a2bbd class=language-output>License_FW_Images.pdf
TPM12_4.40.119.0_to_TPM12_4.43.257.0.BIN
TPM12_4.40.119.0_to_TPM20_5.62.3126.0.BIN
TPM12_4.42.132.0_to_TPM12_4.43.257.0.BIN
TPM12_4.42.132.0_to_TPM20_5.62.3126.0.BIN
TPM12_4.43.257.0_to_TPM20_5.62.3126.0.BIN
TPM12_4.43.257.0_to_TPM20_5.80.2910.2.BIN
TPM12_latest.cfg
TPM20_5.51.2098.0_to_TPM12_4.43.257.0.BIN
TPM20_5.51.2098.0_to_TPM20_5.62.3126.0.BIN
TPM20_5.60.2677.0_to_TPM12_4.43.257.0.BIN
TPM20_5.60.2677.0_to_TPM20_5.62.3126.0.BIN
TPM20_5.61.2785.0_to_TPM12_4.43.257.0.BIN
TPM20_5.61.2785.0_to_TPM20_5.62.3126.0.BIN
TPM20_5.61.2789.0_to_TPM12_4.43.257.0.BIN
TPM20_5.61.2789.0_to_TPM20_5.62.3126.0.BIN
TPM20_5.62.3126.0_to_TPM12_4.43.257.0.BIN
TPM20_latest.cfg
TPMFactoryUpd.efi
TPMFactoryUpd.exe
TVicPort.sys
</code></pre> <p>Now to upgrading the firmware!</p> <h2 id=upgrading-the-firmware>Upgrading the Firmware</h2> <p>Let's make sure <code>TPMFactoryUpd.exe</code> detects the TPM.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=97e4fec2cde048d397d12f3ae73b7787> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=97e4fec2cde048d397d12f3ae73b7787 class=language-ps1>.\TPMFactoryUpd.exe -info
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=0d64fd7844f745218f1ea878b3692088> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=0d64fd7844f745218f1ea878b3692088 class=language-output>  **********************************************************************
  *    Infineon Technologies AG   TPMFactoryUpd   Ver 01.01.2212.00    *
  **********************************************************************

       TPM information:
       ----------------
       Firmware valid                    :    Yes
       TPM family                        :    2.0
       TPM firmware version              :    5.61.2785.0
       TPM platformAuth                  :    Not Empty Buffer
       Remaining updates                 :    64
</code></pre> <p>And it does, sweet! Now to run the upgrade.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=d4e69e6b210b41a3beb447428ad38a85> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=d4e69e6b210b41a3beb447428ad38a85 class=language-ps1>.\TPMFactoryUpd.exe -update config-file -config TPM20_latest.cfg
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=a16dbfd4c6b44749af806728b53496ea> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=a16dbfd4c6b44749af806728b53496ea class=language-output>  **********************************************************************
  *    Infineon Technologies AG   TPMFactoryUpd   Ver 01.01.2212.00    *
  **********************************************************************

       TPM update information:
       -----------------------
       Firmware valid                    :    Yes
       TPM family                        :    2.0
       TPM firmware version              :    5.61.2785.0
       Remaining updates                 :    64
       New firmware valid for TPM        :    Yes
       TPM family after update           :    2.0
       TPM firmware version after update :    5.62.3126.0

       Selected firmware image:
       TPM20_5.61.2785.0_to_TPM20_5.62.3126.0.BIN

       Preparation steps:
       TPM2.0 policy session creation failed.

  ----------------------------------------------------------------------
  *    Error Information                                               *
  ----------------------------------------------------------------------

  Error Code:     0xE0295507
  Message:        TPM2.0: PlatformAuth is not the Empty Buffer. The
                  firmware cannot be updated.

  See the log file (TPMFactoryUpd.log) for further information.
</code></pre> <p>Sad panda, it turns out we need to disable the TPM module in the BIOS/UEFI before we can flash the firmware update. Time to connect my Spider KVM and boot into the UEFI menu. BTW, <a href=https://www.lantronix.com/products/lantronix-spider/ >Spiders</a> are awesome, but don't pay full price!</p> <figure class=figure> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\post-screen.png data-real-width=1024 data-real-height=768 style=max-width:780px><div class=img-container style=padding-top:75%><p class=img-container-inner><img src="" class=img-fluid data-src=/d634f19bb617a4efd8a91545e1ecf331.png alt="Post Screen"/></p></div></div><p></p> <figcaption class=figure-caption>Window Server Core reboots way too fast, had to reboot multiple times to get what button to press.</figcaption> </figure> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\asus-uefi.png data-real-width=1024 data-real-height=768 style=max-width:780px><div class=img-container style=padding-top:75%><p class=img-container-inner><img src="" class=img-fluid data-src=/fa888b255bfd9ba612bd40c8c5a2c130.png alt="Asus UEFI Screen"/></p></div></div><p></p> <p>Now to disable the TPM.</p> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\disable-tpm.png data-real-width=1024 data-real-height=768 style=max-width:780px><div class=img-container style=padding-top:75%><p class=img-container-inner><img src="" class=img-fluid data-src=/3a09bc1587302f1bd92668e55c683cbf.png alt="Disable TPM"/></p></div></div><p></p> <p>After booting back into Windows, it looks like disabling the TPM fixes the <code>Empty Buffer</code> problem:</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=9c84ccf2f7bd4ad394572b14b530a617> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=9c84ccf2f7bd4ad394572b14b530a617 class=language-ps1>.\TPMFactoryUpd.exe -info
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=b7e175576a9042468b30051d2b1a10b9> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=b7e175576a9042468b30051d2b1a10b9 class=language-output>  **********************************************************************
  *    Infineon Technologies AG   TPMFactoryUpd   Ver 01.01.2212.00    *
  **********************************************************************

       TPM information:
       ----------------
       Firmware valid                    :    Yes
       TPM family                        :    2.0
       TPM firmware version              :    5.61.2785.0
       TPM platformAuth                  :    Empty Buffer
       Remaining updates                 :    64
</code></pre> <p>Now I can try to update the TPM again.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=6553dc37a4c64b8c8bff71b47acb6882> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=6553dc37a4c64b8c8bff71b47acb6882 class=language-ps1>cd '.\9665FW update package_1.1\workspace\'
.\TPMFactoryUpd.exe -update config-file -config TPM20_latest.cfg
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=f5226911c97246a0924ca861a7e2ae76> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=f5226911c97246a0924ca861a7e2ae76 class=language-output>  **********************************************************************
  *    Infineon Technologies AG   TPMFactoryUpd   Ver 01.01.2212.00    *
  **********************************************************************

       TPM update information:
       -----------------------
       Firmware valid                    :    Yes
       TPM family                        :    2.0
       TPM firmware version              :    5.61.2785.0
       Remaining updates                 :    64
       New firmware valid for TPM        :    Yes
       TPM family after update           :    2.0
       TPM firmware version after update :    5.62.3126.0

       Selected firmware image:
       TPM20_5.61.2785.0_to_TPM20_5.62.3126.0.BIN

       Preparation steps:
       TPM2.0 policy session created to authorize the update.

    DO NOT TURN OFF OR SHUT DOWN THE SYSTEM DURING THE UPDATE PROCESS!

       Updating the TPM firmware ...
       Completion: 100 %
       TPM Firmware Update completed successfully.
</code></pre> <p>And it works!</p> <h2 id=wrapping-things-up>Wrapping Things Up</h2> <p>A disabled TPM is rather useless, time to boot back into the UEFI menus to enable it.</p> <figure class=figure> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\enable-tpm.png data-real-width=1024 data-real-height=768 style=max-width:780px><div class=img-container style=padding-top:75%><p class=img-container-inner><img src="" class=img-fluid data-src=/c09502d107a3d0c0c5e6fd8725642121.png alt="Enable TPM"/></p></div></div><p></p> <figcaption class=figure-caption>Looks like the UEFI requires a reboot to update this menu.</figcaption> </figure> <p>And since this vulnerability is for RSA key generation, it's best to reset all generated keys. I used a TPM clear to do this, plus a reboot.</p> <p></p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2018\clear-tpm.png data-real-width=1024 data-real-height=768 style=max-width:780px><div class=img-container style=padding-top:75%><p class=img-container-inner><img src="" class=img-fluid data-src=/fefd59c1ef10fd2b8d017d124b6e1629.png alt="Clear TPM"/></p></div></div><p></p> <p>After getting back into Windows, I'm greeted with a lovely success message.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=32f40145033849dd99f857b97c6a0d43> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=32f40145033849dd99f857b97c6a0d43 class=language-ps1>Get-EventLog -LogName System -Source Microsoft-Windows-TPM-WMI | select Message
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=97386c26b974489ca2f625190613a3c8> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=97386c26b974489ca2f625190613a3c8 class=language-output>The TPM was successfully provisioned and is now ready for use.
The TBS device identifier has been generated.
The Ownership of the Trusted Platform Module (TPM) hardware on this computer was successfully taken (TPM TakeOwnership command) by the system.
</code></pre> <p>And as a final check, it looks like the <code>ManufacturerVersion</code> was updated to <code>5.62</code>.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=db2fdbe7943640d5824ceeebe09c54b0> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=db2fdbe7943640d5824ceeebe09c54b0 class=language-ps1>Get-Tpm
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=7ea51bf8a2a24ebfb668f5cee6d19ddf> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=7ea51bf8a2a24ebfb668f5cee6d19ddf class=language-output>TpmPresent          : True
TpmReady            : True
ManufacturerId      : 1229346816
ManufacturerVersion : 5.62
ManagedAuthLevel    : Delegated
OwnerAuth           :
OwnerClearDisabled  : True
AutoProvisioning    : Enabled
LockedOut           : False
LockoutCount        : 0
LockoutMax          : 32
SelfTest            : {}
</code></pre> <p>Yeah, no more weak keys!</p> </main> </div> <div id=comments class=s-comments> <div class=utterances></div> </div> </article> </div> <footer class="text-center s-footer"> <hr> <span> Copyright &copy; Mark Lopez 2021. </span> <span> <a href=/humble-disclaimer/ >Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href=https://creativecommons.org/licenses/by-sa/4.0/ >Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084;</span> by <a href=https://silvenga.com>Silvenga</a>. </span> </footer> <script async defer=defer src=/main.js></script> </body> </html>