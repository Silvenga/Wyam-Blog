<!DOCTYPE html><html><head><title>Silvenga</title><meta http-equiv=content-language content=en-us><meta http-equiv=Content-Type content=text/html charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=HandheldFriendly content=True><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=generator content=Wyam><link rel=stylesheet href=/min.css></head><body><header class=header><div class=fade><h1><a href="/">Silvenga</a></h1><p>Just another Weblog for the masses.</p></div></header><div id=ajax-container><div id=ajax-content><main class=content><nav class=nav-bar><div class=nav-container><div class="nav-text lefted"><a class=h3 href="//"> Browse Posts </a> <a class=h3 href="/projects/"> My Projects </a> <a class=h3 href="/about/"> About Me </a></div><div class="nav-icons righted"><a href=https://twitter.com/Silvenga> <img alt=Twitter class="twit-logo img" src=data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%2F%3E> </a> <a href=https://www.linkedin.com/in/silvenga> <img alt=Linkedin class="link-logo img" src=data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%2F%3E> </a> <a href=https://github.com/Silvenga> <img alt=Github class="github-logo img" src=data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%2F%3E> </a></div></div></nav><div class=body><article class=article><div class=main-container><div class=article-header><h1 class=article-title>Install Windows Server 2016 using Software RAID1</h1><div class=article-date>March 27, 2017 <span class="article-git right"> Commit E9A96FCE from 04-08-2017 - 3 edits total </span></div></div><div class=article-container><div class="article-content flow"><h2 id=setup>Setup</h2><p>Most Windows installers if not all modern versions have a command line option that can be accessed when using the GUI installer (from anywhere from what I can tell). This functionality can be accessed with <code>SHIFT + F10</code> and looks like:</p><p><img src=/content/images/2017/command-line.png class=img-fluid alt=""></p><p>From here we can access <code>diskpart</code>. From Microsoft's Technet, &quot;DiskPart is a text-mode command interpreter [that] enables you to manage objects (disks, partitions, or volumes) by using scripts or direct input at a command prompt.&quot;</p><p>Think <code>parted</code> if you're coming from Linux - but with a lot more functionality. You might have used it under the name &quot;Disk Management&quot;, which is basically a GUI wrapper. We will need this program to preparing the Windows installer to install to a RAID 1 setup.</p><p>To use Diskpart, invoke it from the command line using:</p><pre><code>X:\Sources&gt; diskpart
DISKPART&gt; 
</code></pre><p>You can list all the disks available as so:</p><pre><code>X:\Sources&gt; diskpart
DISKPART&gt; list disk

  Disk ###  Status         Size     Free     Dyn  Gpt
  --------  -------------  -------  -------  ---  ---
  Disk 1    Online          127 GB    127 B        
  Disk 2    Online          127 GB    127 B        

</code></pre><p>In the above example we have two disks, we will put both of these into our RAID1. As can be seen above, <code>diskpart</code> is base 0.</p><h2 id=convert-each-disk-to-dynamic>Convert Each Disk to Dynamic</h2><p>Any mirror setup requires disks to be in dynamic mode - this is basically LVM under Linux. Dynamic disks can be used for a multitude of purposes like disk spanning, mirroring, striping, etc. Although, be careful, there's no going back from dynamic without formatting the disks completely.</p><p>Let's clean each disk before converting them, this uninitialize the disks without a partition scheme. After this disk is empty we enable dynamic mode.</p><pre><code>DISKPART&gt; select disk 0
DISKPART&gt; clean
DISKPART&gt; convert dynamic
</code></pre><p>And do the same thing with the second disk.</p><pre><code>DISKPART&gt; select disk 1
DISKPART&gt; clean
DISKPART&gt; convert dynamic
</code></pre><p><code>list disk</code> should look like this now:</p><p><img src=/content/images/2017/dynamic-disks.png class=img-fluid alt=""></p><h2 id=prepare-mirrors>Prepare Mirrors</h2><p>At this point we can create our RAID1 &quot;partitions&quot;. I use &quot;partitions&quot; in quotes as they aren't really partitions (as they mirror data) but the Windows installer must think of them as partitions. Little weird, but kind of makes sense.</p><p>Windows requires two partitions when in MBR mode (EFI requires 3, which I won't go into). One which is normally called <code>System Reserved</code> and the main OS partition normally without a name (<code>C:/</code>). Both of these partitions need to be created manually as the normal Windows installer cannot.</p><pre><code>DISKPART&gt; select disk 0
DISKPART&gt; create volume mirror disk=0,1 size=500
DISKPART&gt; format quick fs=ntfs label=&quot;System Reserved&quot;

</code></pre><p>These commands create a mirrored volume using disk <code>0</code> and <code>1</code> with a size of <code>500mb</code> (default size under Windows 2016). Then it formats the newly created (and automatically selected) volume using <code>ntfs</code> as the filesystem and &quot;System Reserved&quot; as the volume label.</p><p>Then we can create the OS partition using similar commands:</p><pre><code>DISKPART&gt; select disk 0
DISKPART&gt; create volume mirror disk=0,1
DISKPART&gt; format quick fs=ntfs
</code></pre><p><img src=/content/images/2017/formatted-volumes.png class=img-fluid alt=""></p><p>Using <code>list volume</code> we should see the list of volumes that we created. Note that the volume numbers may be different.</p><h2 id=make-the-mirrors-usable>Make the Mirrors Usable</h2><p>In the above setup, each volume represents a single logical &quot;partition&quot;, but in reality each of these volumes spans two physical drives. These volumes are great under Windows, but not so useful to the BIOS attempting to bootstrap a OS. To make it possible for the BIOS to start Windows we need to create real partitions for each of our mirror volumes.</p><p>First let's use <code>detail disk</code> to make sure we target the correct volumes.</p><pre><code>DISKPART&gt; select disk 0
DISKPART&gt; detail disk
</code></pre><p>In the picture, <code>volume 0</code> is our <code>System Recovery</code> volume and <code>volume 1</code> is our OS volume, different configurations may be different.</p><pre><code>DISKPART&gt; select disk 0
DISKPART&gt; select volume 1
DISKPART&gt; retain
</code></pre><p>This creates a real partition for volume 0 (System Recovery) on disk 0. Use <code>list partition</code> to find to again make sure to target the correct partition.</p><pre><code>DISKPART&gt; select disk 0
DISKPART&gt; list partition
</code></pre><p>Our <code>System Recovery</code> partition is <code>500 MB</code>, in this example, this partition is <code>partition 1</code>.</p><p>To mark the newly created, real partition to be the boot partition we can use the following:</p><pre><code>DISKPART&gt; select disk 0
DISKPART&gt; select partition 2
DISKPART&gt; active
</code></pre><p>We need to do the same thing on the other drive too, as so:</p><pre><code>DISKPART&gt; select disk 1
DISKPART&gt; select volume 1
DISKPART&gt; retain
DISKPART&gt; select disk 1
DISKPART&gt; select partition 2
DISKPART&gt; active
</code></pre><p>We also need a partition for the OS drive (required by the installer). This can be done using the same commands:</p><pre><code>DISKPART&gt; select disk 0
DISKPART&gt; select volume 0
DISKPART&gt; retain
DISKPART&gt; select disk 1
DISKPART&gt; select volume 0
DISKPART&gt; retain
</code></pre><p><img src=/content/images/2017/installed.png class=img-fluid alt=""></p><p>At this point you can install Windows as normal to one of the mirror partitions.</p><h2 id=postscript>Postscript</h2><p>Testing more with HyperV, I discovered that formating the mirrors using Windows setup was required to get a booting OS. I remember doing this before as the IPMI device I was using kept on crashing during installation - forcing me to restart the Windows installation.</p><p><img src=/content/images/2017/formatting-drives.gif class=img-fluid alt=""></p><h2 id=considerations>Considerations</h2><ul><li>This method actually allows you to keep the &quot;System Recovery&quot; partition in sync under a mirror. Microsoft's official white paper on mirroring does provide support for this feature.</li><li>This method also allows you to create a mirror on two drives with different sector sizes - although I personally think disallowing two different sector sizes should be a bug.</li><li>You may need to make sure that you add the second drive as a boot device.</li></ul></div></div></div></article></div><div class="hidden full-width"><div id=title>Silvenga</div><div id=page-id>post.id</div><div id=page-width></div></div></main><footer class=footer id=main-footer><div class=footer-wrapper><div class=footer-container>Copyright &copy; Mark Lopez 2017. <a href="/humble-disclaimer/">My Humble Disclaimer and Privacy Policy</a>.<br>Written under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. <br> Generated on 4/22/2017 2:59:03 AM &#x2B;00:00 using Wyam. <br> Made with <span class=heart>&#10084</span> by <a href=https://silvenga.com>Silvenga</a>.</div></div></footer></div></div><script async defer src=/min.js></script></body></html>