<!DOCTYPE html><html><head><title>Silvenga</title><meta http-equiv=content-language content=en-us><meta http-equiv=Content-Type content=text/html charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=HandheldFriendly content=True><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=generator content=Wyam><link rel=stylesheet href=/min.css></head><body><header class=header><div class=fade><h1><a href="/">Silvenga</a></h1><p>Just another Weblog for the masses.</p></div></header><div id=ajax-container><div id=ajax-content><main class=content><nav class=nav-bar><div class=nav-container><div class="nav-text lefted"><a class=h3 href="//"> Browse Posts </a> <a class=h3 href="/projects/"> My Projects </a> <a class=h3 href="/about/"> About Me </a></div><div class="nav-icons righted"><a href=https://twitter.com/Silvenga> <img alt=Twitter class="twit-logo img" src=data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%2F%3E> </a> <a href=https://www.linkedin.com/in/silvenga> <img alt=Linkedin class="link-logo img" src=data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%2F%3E> </a> <a href=https://github.com/Silvenga> <img alt=Github class="github-logo img" src=data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%2F%3E> </a></div></div></nav><div class=body><article class=article><div class=main-container><div class=article-header><h1 class=article-title>OpenVPN Sheathing</h1><div class=article-date>April 18, 2014 <span class="article-git right"> Commit 9EF0C065 from 01-24-2017 - 1 edit total </span></div></div><div class=article-container><div class="article-content flow"><p><img src=/content/images/2016/10/openvpntech_logo1.png class=img-fluid alt="OpenVPN Logo"></p><p><a href=http://openvpn.net/index.php/open-source/245-community-open-source-software-overview.html>OpenVPN</a> is soon becoming the standard for bypassing Internet censorship - and for good reason. OpenVPN is secure, Open Source, and extremely easy to use. Unfortunately, many censoring ISP's are determined to prevent and block OpenVPN. Possibly the only sure way to block OpenVPN tunnels is a method called <a href=https://en.wikipedia.org/wiki/Deep_packet_inspection>DPI (Deep packet inspection)</a>. What is troubling for many individuals is the fact the DPI works and is now widely used. Although how DPI detects OpenVPN traffic is important I will not talk about it today.</p><h2 id=so-what-is-openvpn-sheathing>So what is OpenVPN Sheathing?</h2><p>OpenVPN Sheathing is a method to hide OpenVPN tunnels from DPI. There are two major ways to accomplish sheathing:</p><p><a href=https://www.stunnel.org/index.html><strong>sTunnel</strong></a>: A GPL Open Source SSL encryption wrapper created by Michal Trojnara. sTunnel creates a full-blown HTTPS tunnel to disguise traffic as what is normally seen on a network. If an ISP were to block HTTPS every user would be severely crippled, thusly not normally done. Unfortunately, there is a performance penalty due to the HTTPS tunnel.</p><p><strong><a href=https://www.torproject.org/projects/obfsproxy.html.en>Obfsproxy</a></strong>: A Tor subproject. This method will make any traffic unrecognisable. This is a lighter method then sTunnel, but may be more easily detected. Rather than blending into normal traffic, Obfsproxy will appear completely different - via plugins. If an ISP were to whitelist allowed protocols rather than blacklist - Obfsproxy may be blocked.</p><p>In this post I will talk about <strong>sTunnel</strong> due to higher reliability and more documentation.</p><h2 id=stunnel>sTunnel</h2><p>So sTunnel has two sides - the <strong>Client</strong> and the <strong>Server</strong>. My server will be running Ubuntu, and since the installation is so similar for the client and server, my client will be running Windows.</p><blockquote class=blockquote><p><em>Disclaimer: I use Ubuntu as my main server OS so all my instructions use the Ubuntu repositories. The configuration files should be compatible with any OS, while the packages can be downloaded from the target's repository.</em></p></blockquote><h3 id=server>Server</h3><p>Our server will act as a relay point (although you can relay to localhost if you need).</p><h4 id=install-stunnel-on-the-server>Install sTunnel on the Server</h4><p>Let's first install sTunnel through <code>apt-get</code>.</p><pre><code>sudo apt-get update            # always a good idea
sudo apt-get upgrade           # let's start fresh
sudo apt-get install stunnel4  # 4 is the newest version as of 4/2014
</code></pre><h4 id=configure-stunnel>Configure sTunnel</h4><p>We are using a HTTPS tunnel so let's generate some HTTPS certificates (self signed).</p><pre><code># let's work in our tmp directory
cd /tmp/

# Use OpenSSL to generate a key called stunnel.key with a bit strength of 2K
# Make sure that we use no password (convenience, OpenVPN is already secure)
openssl genrsa -out stunnel.key 2048             

# Use OpenSSL to generate a new certificate signed by that key we just created
# 1826 days = 5 years, change if needed
openssl req -new -x509 -key stunnel.key -out stunnel.crt -days 1826
</code></pre><p>You should get something like this:</p><blockquote class=blockquote><p><em>You can answer <code>.</code> (period) to all the questions except the <code>Common Name</code> which should be your hostname, public IP address, or DNS name of the server.</em></p></blockquote><pre><code># openssl req -new -x509 -key stunnel.key -out stunnel.crt -days 1826
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:.
State or Province Name (full name) [Some-State]:.
Locality Name (eg, city) []:.
Organization Name (eg, company) [Internet Widgits Pty Ltd]:.
Organizational Unit Name (eg, section) []:.
Common Name (e.g. server FQDN or YOUR name) []:HOSTNAME
Email Address []:.
</code></pre><p>We now have both the certificate and its key. For convenience let's combine the two files into one.</p><pre><code># Concatenate the key and the certificate into the file /etc/stunnel/stunnel.pem
cat stunnel.key stunnel.crt &gt; /etc/stunnel/stunnel.pem
</code></pre><p>Cool, our certificate is ready. Clean up our current directory.</p><pre><code>rm stunnel.crt stunnel.key
</code></pre><p>Move to our sTunnel configuration directory and create a configuration file.</p><pre><code>cd /etc/stunnel/      # Default on Ubuntu
touch stunnel.conf    # We like touching files :P
nano stunnel.conf     # Or your favorite editor 
</code></pre><p>Copy the following into the new file.</p><pre><code># Location of the certificate that we created
cert = /etc/stunnel/stunnel.pem

# Name of the connection
[openvpn-localhost]
# The port to listen on
accept = 8443
# Connect to the local OpenVPN server
connect = 127.0.0.1:1192

# Another alternative
# Forwarding connections to Private Internet Access
[openvpn-florida-usa]
accept = 1198
connect = us-florida.privateinternetaccess.com:443

</code></pre><blockquote class=blockquote><p><em>HTTPS cannot use UDP, so make sure that any OpenVPN server you're connecting to must accept TCP connections!</em></p></blockquote><p>Enable and start sTunnel.</p><pre><code>nano /etc/default/stunnel4
# Change ENABLED=0 to ENABLED=1

service stunnel4 start
</code></pre><p>And we're all set, done with the server side configuration.</p><h3 id=client>Client</h3><p><img src=/content/images/2014/Apr/2014-04-18_19-31-44.png class=img-fluid alt="Windows sTunnel Options"></p><p>Download the Windows sTunnel software.</p><p><a href=https://www.stunnel.org/downloads.html>Stunnel Downloads</a>.</p><p>Install the software with default options.</p><p>Start the software (search for <code>stunnel gui</code>) and edit the configuration with <code>Configuration &gt; Edit Configuration</code>. Copy and paste the following to the end of the file. Make sure to edit <code>remote-server.example.com</code> to be your server address.</p><pre><code>[openvpn-localhost]
# Set sTunnel to be in client mode (defaults to server)
client = yes
# Port to locally connect to
accept = 127.0.0.1:1194
# Remote server for sTunnel to connect to
connect = remote-server.example.com:8443

[openvpn-florida-usa]
client = yes
accept = 127.0.0.1:1198
connect =  remote-server.example.com:1198

</code></pre><p>Reload the configuration by <code>Configuration &gt; Reload Configuration</code>.</p><p>Client side configuration is now complete. When connecting with OpenVPN make sure to connect to that local address, for example: <code>127.0.0.1:1194</code>. This will allow sTunnel to hide the OpenVPN traffic to your server. DPI has no chance to block you now!</p><blockquote class=blockquote><p>Updated: Grammer changes.</p></blockquote><blockquote class=blockquote><p>Updated: <code>client</code> directives are for service configuation not global. Thanks to Johnny.</p></blockquote></div></div></div></article></div><div class="hidden full-width"><div id=title>Silvenga</div><div id=page-id>post.id</div><div id=page-width></div></div></main><footer class=footer id=main-footer><div class=footer-wrapper><div class=footer-container>Copyright &copy; Mark Lopez 2017. <a href="/humble-disclaimer/">My Humble Disclaimer and Privacy Policy</a>.<br>Written under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. <br> Generated on 4/22/2017 12:05:24 AM &#x2B;00:00 using Wyam. <br> Made with <span class=heart>&#10084</span> by <a href=https://silvenga.com>Silvenga</a>.</div></div></footer></div></div><script async defer src=/min.js></script></body></html>