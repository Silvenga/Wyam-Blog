<!DOCTYPE html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=Content-Type content=text/html><meta name=HandheldFriendly content=True><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=generator content="Wyam + Webpack"><title>OpenVPN Sheathing</title><meta name=description content="Sheathing OpenVPN traffic through a SSL tunnel using STunnel."><meta property=og:type content=website><meta property=og:title content="OpenVPN Sheathing"><meta property=og:description content="Sheathing OpenVPN traffic through a SSL tunnel using STunnel."><meta property=og:locale content=en_US><meta name=twitter:card content=summary><meta name=twitter:site content=@Silvenga><meta name=twitter:creator content=@Silvenga><link rel=prefetch href=/gist-loader.js><link rel=prefetch href=/gist-loader><link rel=preconnect href=https://piwik.silvenga.com><link rel=preload href=https://piwik.silvenga.com/piwik.js as=script><link rel=preload href=/main.js as=script><link rel=stylesheet href=/main.css></head><body><header class="container-fluid s-nav" id=loading-bar role=banner><nav class="navbar row" role=navigation><div class="nav col-sm d-flex s-nav-left p-0"><a class="nav-item nav-link" href="/"> <span class=logo></span> Silvenga's Blog <sub>(beta)</sub> </a></div><div class="nav col-sm s-nav-right p-0"><a class="nav-item nav-link" href="/projects/">Projects</a> <a class="nav-item nav-link" href="/about/">About</a> <a class="nav-item nav-link" href=https://github.com/Silvenga><span class=github></span></a></div></nav></header><div id=ajax-container><script type=application/ld+json>
{
  "@context" : "http://schema.org",
  "@type" : "Article",
  "headline" : "OpenVPN Sheathing",
  "datePublished" : "2014-04-18T00:00:00.0000000",
  "dateModified": "2017-12-15T22:42:21.0000000-06:00",
  "author": {
      "name": "Mark Lopez"
  },
  "description": "Sheathing OpenVPN traffic through a SSL tunnel using STunnel."
}
</script><article class="s-content pt-4 m-4 flex-column align-items-stretch"><div class="flex-column d-flex justify-content-center align-items-center"><div class=s-title><h1 class="display-4 text-center">OpenVPN Sheathing</h1><div class=text-center>Created on <time datetime=2014-04-18T00:00:00.0000000>April 18, 2014</time>.</div><div class=text-center>Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/eb92f788>eb92f788</a> on <time datetime=2017-12-15T22:42:21.0000000-06:00>December 15, 2017</time> - 5 total changes.</div><hr></div></div><div class="justify-content-center mt-2"><main class="s-article d-flex flex-column align-items-center" role=main><p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2016\10\openvpntech_logo1.png style=max-width:780px><div class=img-container style=padding-top:28.888888888888888888888888890%><p class=img-container-inner><img src=/content/images/2016/10/openvpntech_logo1.png class=img-fluid alt="OpenVPN Logo"></p></div></div></p><p><a href=http://openvpn.net/index.php/open-source/245-community-open-source-software-overview.html>OpenVPN</a> is soon becoming the standard for bypassing Internet censorship - and for good reason. OpenVPN is secure, Open Source, and extremely easy to use. Unfortunately, many censoring ISP's are determined to prevent and block OpenVPN. Possibly the only sure way to block OpenVPN tunnels is a method called <a href=https://en.wikipedia.org/wiki/Deep_packet_inspection>DPI (Deep packet inspection)</a>. What is troubling for many individuals is the fact the DPI works and is now widely used. Although how DPI detects OpenVPN traffic is important I will not talk about it today.</p><h2 id=so-what-is-openvpn-sheathing>So what is OpenVPN Sheathing?</h2><p>OpenVPN Sheathing is a method to hide OpenVPN tunnels from DPI. There are two major ways to accomplish sheathing:</p><p><a href=https://www.stunnel.org/index.html><strong>sTunnel</strong></a>: A GPL Open Source SSL encryption wrapper created by Michal Trojnara. sTunnel creates a full-blown HTTPS tunnel to disguise traffic as what is normally seen on a network. If an ISP were to block HTTPS every user would be severely crippled, thusly not normally done. Unfortunately, there is a performance penalty due to the HTTPS tunnel.</p><p><strong><a href=https://www.torproject.org/projects/obfsproxy.html.en>Obfsproxy</a></strong>: A Tor subproject. This method will make any traffic unrecognisable. This is a lighter method then sTunnel, but may be more easily detected. Rather than blending into normal traffic, Obfsproxy will appear completely different - via plugins. If an ISP were to whitelist allowed protocols rather than blacklist - Obfsproxy may be blocked.</p><p>In this post I will talk about <strong>sTunnel</strong> due to higher reliability and more documentation.</p><h2 id=stunnel>sTunnel</h2><p>So sTunnel has two sides - the <strong>Client</strong> and the <strong>Server</strong>. My server will be running Ubuntu, and since the installation is so similar for the client and server, my client will be running Windows.</p><blockquote class=blockquote><p><em>Disclaimer: I use Ubuntu as my main server OS so all my instructions use the Ubuntu repositories. The configuration files should be compatible with any OS, while the packages can be downloaded from the target's repository.</em></p></blockquote><h3 id=server>Server</h3><p>Our server will act as a relay point (although you can relay to localhost if you need).</p><h4 id=install-stunnel-on-the-server>Install sTunnel on the Server</h4><p>Let's first install sTunnel through <code>apt-get</code>.</p><div class=code-header><span class=language>Bash</span> <button class=copy data-copy-id=dd356b59881c407087b9ef4e7cd8d3a0> <span>Copy</span> </button></div><pre><code data-copy-target=dd356b59881c407087b9ef4e7cd8d3a0 class=language-bash>sudo apt-get update            # always a good idea
sudo apt-get upgrade           # let's start fresh
sudo apt-get install stunnel4  # 4 is the newest version as of 4/2014
</code></pre><h4 id=configure-stunnel>Configure sTunnel</h4><p>We are using a HTTPS tunnel so let's generate some HTTPS certificates (self signed).</p><div class=code-header><span class=language>Bash</span> <button class=copy data-copy-id=e65ac2bd819b49bbac1f46ac98cedf35> <span>Copy</span> </button></div><pre><code data-copy-target=e65ac2bd819b49bbac1f46ac98cedf35 class=language-bash># let's work in our tmp directory
cd /tmp/

# Use OpenSSL to generate a key called stunnel.key with a bit strength of 2K
# Make sure that we use no password (convenience, OpenVPN is already secure)
openssl genrsa -out stunnel.key 2048             

# Use OpenSSL to generate a new certificate signed by that key we just created
# 1826 days = 5 years, change if needed
openssl req -new -x509 -key stunnel.key -out stunnel.crt -days 1826
</code></pre><p>You should get something like this:</p><blockquote class=blockquote><p><em>You can answer <code>.</code> (period) to all the questions except the <code>Common Name</code> which should be your hostname, public IP address, or DNS name of the server.</em></p></blockquote><div class=code-header><span class=language>Bash</span> <button class=copy data-copy-id=1eb299b153bb4288ba704300dd7b4a93> <span>Copy</span> </button></div><pre><code data-copy-target=1eb299b153bb4288ba704300dd7b4a93 class=language-bash># openssl req -new -x509 -key stunnel.key -out stunnel.crt -days 1826
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:.
State or Province Name (full name) [Some-State]:.
Locality Name (eg, city) []:.
Organization Name (eg, company) [Internet Widgits Pty Ltd]:.
Organizational Unit Name (eg, section) []:.
Common Name (e.g. server FQDN or YOUR name) []:HOSTNAME
Email Address []:.
</code></pre><p>We now have both the certificate and its key. For convenience let's combine the two files into one.</p><div class=code-header><span class=language>Bash</span> <button class=copy data-copy-id=608be15d21fc4ebfb89cf16523d1ec95> <span>Copy</span> </button></div><pre><code data-copy-target=608be15d21fc4ebfb89cf16523d1ec95 class=language-bash># Concatenate the key and the certificate into the file /etc/stunnel/stunnel.pem
cat stunnel.key stunnel.crt &gt; /etc/stunnel/stunnel.pem
</code></pre><p>Cool, our certificate is ready. Clean up our current directory.</p><div class=code-header><span class=language>Bash</span> <button class=copy data-copy-id=5a9e66333c354fd9b21a11901f6fca74> <span>Copy</span> </button></div><pre><code data-copy-target=5a9e66333c354fd9b21a11901f6fca74 class=language-bash>rm stunnel.crt stunnel.key
</code></pre><p>Move to our sTunnel configuration directory and create a configuration file.</p><div class=code-header><span class=language>Bash</span> <button class=copy data-copy-id=a0330907649f49118e3b51bdfb87af20> <span>Copy</span> </button></div><pre><code data-copy-target=a0330907649f49118e3b51bdfb87af20 class=language-bash>cd /etc/stunnel/      # Default on Ubuntu
touch stunnel.conf    # We like touching files :P
nano stunnel.conf     # Or your favorite editor 
</code></pre><p>Copy the following into the new file.</p><div class=code-header><span class=language>Code</span> <button class=copy data-copy-id=b2e151b487204ba690e81361c7ed6511> <span>Copy</span> </button></div><pre><code data-copy-target=b2e151b487204ba690e81361c7ed6511># Location of the certificate that we created
cert = /etc/stunnel/stunnel.pem

# Name of the connection
[openvpn-localhost]
# The port to listen on
accept = 8443
# Connect to the local OpenVPN server
connect = 127.0.0.1:1192

# Another alternative
# Forwarding connections to Private Internet Access
[openvpn-florida-usa]
accept = 1198
connect = us-florida.privateinternetaccess.com:443

</code></pre><blockquote class=blockquote><p><em>HTTPS cannot use UDP, so make sure that any OpenVPN server you're connecting to must accept TCP connections!</em></p></blockquote><p>Enable and start sTunnel.</p><div class=code-header><span class=language>Bash</span> <button class=copy data-copy-id=58fb657bd26848378dcda49f7951b565> <span>Copy</span> </button></div><pre><code data-copy-target=58fb657bd26848378dcda49f7951b565 class=language-bash>nano /etc/default/stunnel4
# Change ENABLED=0 to ENABLED=1

service stunnel4 start
</code></pre><p>And we're all set, done with the server side configuration.</p><h3 id=client>Client</h3><p><div class=img-container-outer data-real-path=C:\projects\silvenga-com\input\posts\content\images\2014\Apr\2014-04-18_19-31-44.png style=max-width:436px><div class=img-container style=padding-top:69.266055045871559633027522940%><p class=img-container-inner><img src=/content/images/2014/Apr/2014-04-18_19-31-44.png class=img-fluid alt="Windows sTunnel Options"></p></div></div></p><p>Download the Windows sTunnel software.</p><p><a href=https://www.stunnel.org/downloads.html>Stunnel Downloads</a>.</p><p>Install the software with default options.</p><p>Start the software (search for <code>stunnel gui</code>) and edit the configuration with <code>Configuration &gt; Edit Configuration</code>. Copy and paste the following to the end of the file. Make sure to edit <code>remote-server.example.com</code> to be your server address.</p><div class=code-header><span class=language>Code</span> <button class=copy data-copy-id=36c33b266e8d4fe4b05e84c73467286b> <span>Copy</span> </button></div><pre><code data-copy-target=36c33b266e8d4fe4b05e84c73467286b>[openvpn-localhost]
# Set sTunnel to be in client mode (defaults to server)
client = yes
# Port to locally connect to
accept = 127.0.0.1:1194
# Remote server for sTunnel to connect to
connect = remote-server.example.com:8443

[openvpn-florida-usa]
client = yes
accept = 127.0.0.1:1198
connect =  remote-server.example.com:1198
</code></pre><p>Reload the configuration by <code>Configuration &gt; Reload Configuration</code>.</p><p>Client side configuration is now complete. When connecting with OpenVPN make sure to connect to that local address, for example: <code>127.0.0.1:1194</code>. This will allow sTunnel to hide the OpenVPN traffic to your server. DPI has no chance to block you now!</p><blockquote class=blockquote><p>Updated: Grammer changes.</p></blockquote><blockquote class=blockquote><p>Updated: <code>client</code> directives are for service configuation not global. Thanks to Johnny.</p></blockquote></main></div></article></div><footer class="text-center s-footer"><hr><span> Copyright &copy; Mark Lopez 2018. </span> <span> <a href="/humble-disclaimer/">Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084;</span> by <a href=https://silvenga.com>Silvenga</a>. </span></footer><script async defer src=/main.js></script></body></html>