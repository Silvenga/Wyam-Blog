<!DOCTYPE html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=Content-Type content=text/html><meta name=HandheldFriendly content=True><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=generator content="Wyam + Webpack"><title>Virtual Disk Service Stalled</title><meta name=description content="My journey in troubleshooting Virtual Disk Service issues."><meta property=og:type content=website><meta property=og:title content="Virtual Disk Service Stalled"><meta property=og:description content="My journey in troubleshooting Virtual Disk Service issues."><meta property=og:locale content=en_US><meta name=twitter:card content=summary><meta name=twitter:site content=@Silvenga><meta name=twitter:creator content=@Silvenga><link rel=prefetch href=/gist-loader.js><link rel=prefetch href=/gist-loader><link rel=preconnect href=https://piwik.silvenga.com><link rel=preload href=https://piwik.silvenga.com/piwik.js as=script><link rel=preload href=/main.js as=script><link rel=stylesheet href=/main.css></head><body><header class="container-fluid s-nav" id=loading-bar role=banner><nav class="navbar row" role=navigation><div class="nav col-sm d-flex s-nav-left p-0"><a class="nav-item nav-link" href="/"> <span class=logo></span> Silvenga's Blog <sub>(beta)</sub> </a></div><div class="nav col-sm s-nav-right p-0"><a class="nav-item nav-link" href="/projects/">Projects</a> <a class="nav-item nav-link" href="/about/">About</a></div></nav></header><div id=ajax-container><script type=application/ld+json>
{
  "@context" : "http://schema.org",
  "@type" : "Article",
  "headline" : "Virtual Disk Service Stalled",
  "datePublished" : "2017-07-21T23:24:45.0000000",
  "dateModified": "2017-12-10T15:12:32.0000000-06:00",
  "author": {
      "name": "Mark Lopez"
  },
  "description": "My journey in troubleshooting Virtual Disk Service issues."
}
</script><article class="s-content pt-4 m-4 flex-column align-items-stretch"><div class="flex-column d-flex justify-content-center align-items-center"><div class=s-title><h1 class="display-4 text-center">Virtual Disk Service Stalled</h1><div class=text-center>Created on <time datetime=2017-07-21T23:24:45.0000000>July 21, 2017</time>.</div><div class=text-center>Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/7f99874a>7f99874a</a> on <time datetime=2017-12-10T15:12:32.0000000-06:00>December 10, 2017</time> - 4 total changes.</div><hr></div></div><div class="justify-content-center mt-2"><main class="s-article d-flex flex-column align-items-center" role=main><p>I had this really odd problem that's been plaguing me for months on a newly installed Windows 2016 dedicated machine. Random services and tools either stopped functioning or froze/stalled for minutes at a time. I really thought that I either had a corrupted installation (<code>sfc</code> couldn't detect anything) or I configured something horribly wrong. So, as a last ditch effort before completely re-installing the machine, I finally took some time one night to perform a root cause analysis and to hopefully find a solution. What precedes is that night.</p><h2 id=all-the-issues>All the Issues!</h2><blockquote class=blockquote><p>They don't make bugs like Bunny anymore. - Olav Mjelde.</p></blockquote><p>At first I noticed that I was having issues connecting to the Windows SNMP (Simple Network Management Protocol) service which I use to monitor all my servers. My SNMP monitoring system would timeout connecting to the service 99% of the time. This was very odd, and the patterns didn't present in a way that would scream networking issues. I checked all the common causes (VPN issues, monitoring host, DNS, etc), but came up empty. Attempting to restart the service resulted it hanging until I rebooted. Not really caring, I continued on thinking it was network related - my VPN always had Window issues (architecture portable != OS portable).</p><p><img src=/content/images/2017/7/task-manager.png class=img-fluid data-real-path=C:\projects\silvenga-com\input\posts\content\images\2017\7\task-manager.png height=591 width=664 alt="Task Manager"></p><p>Later I noticed that Windows Updates were taking forever, so wanting to know the bottleneck, I checked the Resource Monitor. No resource issues that I could find, however, no IO stats were showing either and no disks were shown under the Storage section. To double check this oddity, I enabled IO performance stats within <a href="https://blogs.technet.microsoft.com/canitpro/2013/12/02/step-by-step-enabling-disk-performance-counters-in-windows-server-2012-r2-task-manager/">Task Manager</a> - this should pull from the same location as the Resource Monitor (IIRC). The Task Manager also failed to get disk information for me - as well as the Server Manager, which I tried later. At this point I was really questioning the integrity of this server, but ran a <code>fsck</code> check anyway (I didn't really think it would help, but why not?). After the reboot, nothing came up, this had no impact on my issue.</p><p>Oddly all these issues basically revolved around disk issues, time to check that part of the system? Now, I'm running this particular server in a software RAID-1 (it's a cheap server) using the same method I wrote about <a href="https://silvenga.com/raid1-windows-server-2016/">here</a>. This is definitely not a standard solution in the Windows land, but I've tested this method in my testbed, and have never any had issues. I truly didn't believe this to be the problem, but I fired up Disk Management just to poke around. The message <code>Connecting to Virtual Disk Service...</code> greeted me and wouldn't leave (yes, the Virtual Disk service was enabled and running, I restarted it to make sure).</p><h2 id=the-ultimate-solution>The Ultimate Solution</h2><blockquote class=blockquote><p>Hardware: the parts of a computer that can be kicked. - Jeff Pesis</p></blockquote><p>This is when the pieces started to fit together - something that the Virtual Disk service accessed was having issues. I bet if I waited long enough, whatever thing that was stalling the service would timeout. I opted to test this by opening the Task Manager and waiting for the IO stats to display. Behold, my patience was rewarded! Now to isolate the root cause...</p><p>I remembered back to earlier this year, when installing Windows onto this server. The SuperMicro IPMI management interface would keep on crashing or stopped responding to commands (again, this is a cheap dedi) - this kept on causing the Windows installer to fail. As a side note, I will never use SuperMicro again for personal projects, just a horrible experience (go HPE!).</p><p>I hypothesized that perhaps one of the IPMI interface's virtual disk drives were causing issues with Windows (like not responding to requests). I tried to check either of the drive's properties using Explorer (This PC), I was rewarded with Explorer freezing and ultimately crashing. Lovely, but at least I was on the right path about the IPMI...</p><p><img src=/content/images/2017/7/device-manager.png class=img-fluid data-real-path=C:\projects\silvenga-com\input\posts\content\images\2017\7\device-manager.png height=219 width=407 alt="device manager"></p><p>Immediately, I opened up the Device Manager and proceeded to disable anything AMI (SuperMicro's vendor). Device Manager did stall, but after a couple of minutes of waiting I was prompted to reboot to complete my modifications - which I proceeded to do smugly.</p><p>Almost like magic, all my issues just disappeared! No more SNMP timeouts, IO stats started working, Disk Management worked, Windows updates wouldn't hang, and I swear the whole OS felt just a bit faster.</p><p>Life is good.</p></main></div></article></div><footer class="text-center s-footer"><hr><span> Copyright &copy; Mark Lopez 2018. </span> <span> <a href="/humble-disclaimer/">Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084;</span> by <a href=https://silvenga.com>Silvenga</a>. </span></footer><script async defer src=/main.js></script></body></html>