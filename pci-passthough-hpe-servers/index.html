 <!doctype html> <html lang=en-us dir=ltr> <head> <meta charset=utf-8 /> <meta http-equiv=Content-Type content=text/html /> <meta name=HandheldFriendly content=True /> <meta name=viewport content="width=device-width,initial-scale=1"/> <meta name=generator content="Wyam + Webpack"/> <meta name=theme-color content=#000000 /> <title>Hypervisor PCI Passthrough on Modern HPE Servers</title> <meta name=description content="Getting iLO to play nice with Hyper-V Discrete Device Assignment"> <meta property=og:type content=website> <meta property=og:title content="Hypervisor PCI Passthrough on Modern HPE Servers"> <meta property=og:description content="Getting iLO to play nice with Hyper-V Discrete Device Assignment"> <meta property=og:locale content=en_US> <meta name=twitter:card content=summary> <meta name=twitter:site content=@Silvenga> <meta name=twitter:creator content=@Silvenga> <link rel=prefetch href=/gist-loader.js> <link rel=prefetch href=/gist-loader> <link rel=preconnect href=https://matomo.silvenga.com> <link rel=preload href=https://matomo.silvenga.com/piwik.js as=script> <link rel=preload href=/main.js as=script> <link rel=stylesheet href=/main.css> </head> <body> <header class="container-fluid s-nav" id=loading-bar role=banner> <nav class="navbar row" role=navigation> <div class="nav col-sm d-flex s-nav-left p-0"> <a class="nav-item nav-link" href=/ > <span class=logo></span> Silvenga's Blog </a> </div> <div class="nav col-sm s-nav-right p-0"> <a class="nav-item nav-link" href=/projects/ >Projects</a> <a class="nav-item nav-link" href=/about/ >About</a> <a class="nav-item nav-link" href=https://github.com/Silvenga aria-label=Github><span class=github></span></a> </div> </nav> </header> <div id=ajax-container> <script type=application/ld+json> {
  "@context" : "http://schema.org",
  "@type" : "Article",
  "headline" : "Hypervisor PCI Passthrough on Modern HPE Servers",
  "datePublished" : "2021-01-23T23:08:05.0000000",
  "dateModified": "2021-01-23T23:08:05.0000000-06:00",
  "author": {
      "name": "Mark Lopez"
  },
  "description": "Getting iLO to play nice with Hyper-V Discrete Device Assignment"
} </script> <article class="s-content pt-4 m-4 flex-column align-items-stretch"> <div class="flex-column d-flex justify-content-center align-items-center"> <div class=s-title> <h1 class="display-4 text-center">Hypervisor PCI Passthrough on Modern HPE Servers</h1> <div class=text-center> Created on <time datetime=2021-01-23T23:08:05.0000000>January 23, 2021</time>. </div> <div class=text-center> Last commit <a class=text-uppercase href=https://github.com/Silvenga/silvenga.com/commit/af960b2d>af960b2d</a> on <time datetime=2021-01-23T23:08:05.0000000-06:00>January 23, 2021</time> - 1 total changes. </div> <hr> </div> </div> <div class="justify-content-center mt-2"> <main class="s-article d-flex flex-column align-items-center" role=main> <h2 id=the-problem>The Problem</h2> <p>On my Gen8 HPE Proliants, I run a hyperconvergence, hybrid OS infrastructure, mixing the best of Windows and Linux. My hypervisor of choice is Hyper-V, mainly so I can get TPM protected full disk encryption (which, incredibly, every Linux distro is still lacking!) to allow unattended rolling cluster updates. Anything I can do to reduce the amount of required maintenance, since everyone is applying security updates monthly, right?</p> <p>Lately I've been building out my NAS, a 75TiB raw Ceph cluster (unattended rolling reboots is a theme here :D), and I've been doing disk level passthrough of my disks to my Ceph nodes. Anyone familiar with Hyper-V can likely see the problem - Ceph really likes to see the real disk, and Hyper-V's disk abstraction hides a lot of data (IMO, this is the correct implementation, but that's another topic). Everything from write caching to SMART data is just not exposed to the guest VM's.</p> <p>The latter, the missing SMART data is my main concern right now. As my spindles age, they are going to start having more and more problems. For example, just last week, two drives started throwing write errors, one of which started dropping off my SAS controller!</p> <p>Wouldn't it be awesome if I could expose my HBA PCI SAS controller to the Ceph VM? Let the VM handle writes directly, without getting Hyper-V involved?</p> <p>Why, yes. That would be awesome!</p> <h2 id=the-solution>The Solution?</h2> <p>Hyper-V is a type 1 hypervisor, meaning the hypervisor runs directly on hardware, with the management OS running in a VM. The management OS executes within the root partition, and gets special treatment like full access to most resources, this includes disks, network adapters, and PCI cards. When you perform disk level passthrough, you have to unmount the disk from the management OS (e.g. offline the disk in Windows terminology). Effectively, the SATA/SAS controller is still shared with the management OS, which means the guest VM's cannot take full control.</p> <p>Of course, there are a lot of things that can't be effectively shared between multiple OS's, like graphics cards or wifi cards. For these cases, type 1 hypervisors normally have some kind of pci passthrough feature, allowing you to assign a complete device to a single VM.</p> <p>Hey, isn't that's called DDA (Discrete Device Assignment) in Hyper-V? Why, yes it is. With DDA I should be able to passthrough my HBA card directly to Ceph. This is super trivial, so let's try that really quick, there's even a little script that shows compatibility!</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=08917ea354704e27825ce2dcbdf8b792> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=08917ea354704e27825ce2dcbdf8b792 class=language-powershell>Start-BitsTransfer https://github.com/MicrosoftDocs/Virtualization-Documentation/raw/live/hyperv-tools/DiscreteDeviceAssignment/SurveyDDA.ps1 SurveyDDA.ps1
.\SurveyDDA.ps1
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=90d44bd5bf1c4575a0f9cc3023599d8a> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=90d44bd5bf1c4575a0f9cc3023599d8a class=language-output>Generating a list of PCI Express endpoint devices
...
HP H220 Host Bus Adapter
BIOS requires that this device remain attached to BIOS-owned memory.  Not assignable.
</code></pre> <p>Uhm... that's annoying...</p> <h2 id=whats-wrong>What's wrong?</h2> <p>First things, what does this message even mean?</p> <p>Well, all modern OS's (Windows Server 2016+ and modern versions of the Linux kernel) will respect a portion of memory that the BIOS flags before the handover to the OS. This is called the RMRR (Reserved memory Region Reporting) portion of memory. This portion of memory may exist for each device enumerated.</p> <p>When the hypervisor attaches a PCI device to a VM, it will setup a translation from the abstraction sandbox (the VM) to the physical hardware in memory (also called DMA, direct memory access). Translations to devices that have a RMRR aren't allowed (my understanding is that this 1) breaks VT-d spec and 2) breaks the hypervisor abstraction).</p> <p>Basically, the BIOS reserved a portion of memory it controls, that the OS shouldn't touch. This disallows assigning a PCI device to a VM (using DMA).</p> <blockquote class=blockquote> <p>Additional reading: <a href=https://www.kernel.org/doc/Documentation/Intel-IOMMU.txt>https://www.kernel.org/doc/Documentation/Intel-IOMMU.txt</a> <a href=https://software.intel.com/content/www/us/en/develop/articles/intel-virtualization-technology-for-directed-io-vt-d-enhancing-intel-platforms-for-efficient-virtualization-of-io-devices.html>https://software.intel.com/content/www/us/en/develop/articles/intel-virtualization-technology-for-directed-io-vt-d-enhancing-intel-platforms-for-efficient-virtualization-of-io-devices.html</a></p> </blockquote> <h2 id=why-doesnt-the-bios-want-to-share>Why doesn't the BIOS want to share?</h2> <p>So, RMRR only describes the error message. But why is the BIOS setting up RMRR in the first place?</p> <p>Well, the answer to that came from an observation here at the Spiceworks community: <a href=https://community.spiceworks.com/topic/2250178-passthrough-p420i-to-virtual-machine-on-gen8-hpe>https://community.spiceworks.com/topic/2250178-passthrough-p420i-to-virtual-machine-on-gen8-hpe</a></p> <p>Disabling iLO (Integrated Lights-Out, HPE's IPMI) apparently makes PCI passthrough work.</p> <p>Going deeper, this BIOS controlled RMRR comes from the HPE &quot;Sea of Sensors&quot; found HPE servers (with Gen8 being the first generation to have this feature). HPE's marketing aside, functionally, iLO inserts itself into almost every component, to gather metrics, health information, and to provide an inventory. iLO handles this at the BIOS level, using RMRR to handle the data for each device. Disabling iLO will of course disable these sensors, removing the RMRR, allowing DMA once again.</p> <p>But disabling the iLO sucks, I strongly consider that a non-solution to getting SMART stats into my Ceph cluster.</p> <h2 id=the-real-solution>The real solution!</h2> <p>I searched for hours for a solution to this. Dozens of posts on forums, and no one had a solution. Mostly blame for the hardware, blame of &quot;Sea of Sensors&quot;, blame against Hyper-V. No solution!</p> <p>Eventually, I found a little luck. Deep in HPE's support archive, there's a customer advisory from 2016 talking about an error message from KVM.</p> <blockquote class=blockquote> <p>Device is ineligible for IOMMU domain attach due to platform RMRR requirement. Contact your platform vendor. <a href="https://support.hpe.com/hpesc/public/docDisplay?docId=emr_na-c04781229">https://support.hpe.com/hpesc/public/docDisplay?docId=emr_na-c04781229</a></p> </blockquote> <p>That sounds a lot like the error from Hyper-V...</p> <p>It turns out, there are a huge amount of BIOS settings not exposed in the BIOS options. One of these settings is around enabling/disabling RMRR on each PCI slot. The only way to modify these settings is by using XML and the conrep interface (a binary that interacts with the BIOS ROM directly).</p> <p>Let's do that now:</p> <blockquote class=blockquote> <p>Doing this in Windows, since a lot of people think this is Linux only. Under Ubuntu, the <code>hp-scripting-tools</code> package provides <code>conrep</code>.</p> </blockquote> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=bc3b1af7d5114e18821472ec72fe4346> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=bc3b1af7d5114e18821472ec72fe4346 class=language-powershell># Download and install the tools:
Start-BitsTransfer https://downloads.hpe.com/pub/softlib2/software1/pubsw-windows/p230763598/v138934/HPEBIOSCmdlets-x64.msi HPEBIOSCmdlets-x64.msi
msiexec /i HPEBIOSCmdlets-x64.msi /qn
</code></pre> <div class="code-header lang-code"> <span class=language>Code</span> <button class=copy data-copy-id=71f47e7aeafd4d838b39535ef655ef54> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-code copy-pending"><code data-copy-target=71f47e7aeafd4d838b39535ef655ef54># Let conrep load the required driver:
cp &quot;C:\Program Files\Hewlett Packard Enterprise\PowerShell\Modules\HPEBIOSCmdlets\Tools\ConfigurationData\winpe50\hpsstkio\hpsstkio.sys&quot; &quot;C:\Windows\System32\drivers\hpsstkio.sys&quot;

# Profit!
$conrep = &quot;C:\Program Files\Hewlett Packard Enterprise\PowerShell\Modules\HPEBIOSCmdlets\Tools\ConfigurationData\conrep.exe&quot;

# Save the current settings (-s)
# Using the schema (-x)
# To the file existing-settings.xml (-f)
&amp; $conrep -s -x &quot;C:\Program Files\Hewlett Packard Enterprise\PowerShell\Modules\HPEBIOSCmdlets\Tools\ConfigurationData\conrep.xml&quot; -f C:\existing-settings.xml
</code></pre> <p>Here <code>conrep.xml</code> is just a schema for the basic settings in the BIOS. Looking at the file, there's a bunch of settings:</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=9011bab6a42d41138bf7b591380a9582> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=9011bab6a42d41138bf7b591380a9582 class=language-powershell>cat C:\existing-settings.xml
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=0ba87a3fc61b4b71837baa12fb203c36> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=0ba87a3fc61b4b71837baa12fb203c36 class=language-output>&lt;Conrep version=&quot;4.7.1.0&quot; originating_platform=&quot;ProLiant DL380p Gen8&quot; originating_family=&quot;P70&quot; originating_romdate=&quot;05/24/2019&quot; originating_processor_manufacturer=&quot;Intel&quot;&gt;
  &lt;Section name=&quot;IMD_ServerName&quot; helptext=&quot;LCD Display name for this server&quot;&gt;&lt;Line0&gt;GH2&lt;/Line0&gt;&lt;/Section&gt;
  &lt;Section name=&quot;IPL_Order&quot; helptext=&quot;Current Initial ProgramLoad device boot order.&quot;&gt;&lt;Index0&gt;00&lt;/Index0&gt;&lt;Index1&gt;01&lt;/Index1&gt;&lt;Index2&gt;03&lt;/Index2&gt;&lt;Index3&gt;02&lt;/Index3&gt;&lt;Index4&gt;04&lt;/Index4&gt;&lt;Index5&gt;05&lt;/Index5&gt;&lt;Index6&gt;ff&lt;/Index6&gt;&lt;Index7&gt;ff&lt;/Index7&gt;&lt;Index8&gt;ff&lt;/Index8&gt;&lt;Index9&gt;ff&lt;/Index9&gt;&lt;Index10&gt;ff&lt;/Index10&gt;&lt;Index11&gt;ff&lt;/Index11&gt;&lt;Index12&gt;ff&lt;/Index12&gt;&lt;Index13&gt;ff&lt;/Index13&gt;&lt;Index14&gt;ff&lt;/Index14&gt;&lt;Index15&gt;ff&lt;/Index15&gt;&lt;/Section&gt;
...
</code></pre> <p>Some interesting stuff!</p> <p>Less obvious is that there are other schemas you can use to read and modify the BIOS settings with. In my case, I needed the RMRD schema:</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=8f37065476c247e1b5e5468c1f61a22b> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=8f37065476c247e1b5e5468c1f61a22b class=language-powershell>Start-BitsTransfer https://downloads.hpe.com/pub/softlib2/software1/pubsw-linux/p1472592088/v95853/conrep_rmrds.xml conrep_rmrds.xml
cat conrep_rmrds.xml
</code></pre> <div class="code-header lang-output"> <span class=language>Output</span> <button class=copy data-copy-id=8fbb38c86b824773a2e0bc16a59cc72f> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-output copy-pending"><code data-copy-target=8fbb38c86b824773a2e0bc16a59cc72f class=language-output>...
This is the input file for CONREP describing Reserved Memory Region Device Scope(RMRDS) entries.
Endpoints_Included = All endpoints in slot should be included in Reserved Memory Region Device Scope entries (default for all slots)
Endpoints_Excluded = All endpoints in slot should be excluded from Reserved Memory Region Device Scope entries
...
</code></pre> <p>Modifying these settings is as simple as reading the existing settings (using the rmrds schema), modifying the resulting XML, and uploading the XML back the the BIOS ROM.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=1b2167af58454f369b051ec3a2675333> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=1b2167af58454f369b051ec3a2675333 class=language-powershell>&amp; $conrep -s -x conrep_rmrds.xml -f rmrds.xml
&amp; $conrep -l -x conrep_rmrds.xml -f rmrds.xml
</code></pre> <p>Where <code>-l</code> means &quot;load&quot;.</p> <p>You can even just modify part of the XML, and upload that, which is easier to automate.</p> <div class="code-header lang-powershell"> <span class=language>PowerShell</span> <button class=copy data-copy-id=8755bdff4f7247f1b14fb8c9925e1064> <i class=copy-icon></i> <span>Copy</span> </button></div><pre class="lang-powershell copy-pending"><code data-copy-target=8755bdff4f7247f1b14fb8c9925e1064 class=language-powershell>'&lt;Conrep&gt;&lt;Section name=&quot;RMRDS_Slot2&quot; helptext=&quot;.&quot;&gt;Endpoints_Excluded&lt;/Section&gt;&lt;/Conrep&gt;' | Out-File override-rmrds.xml
&amp; $conrep -l -x conrep_rmrds.xml -f override-rmrds.xml
</code></pre> <p>Reboot, and the PCI slot should be RMRR free!</p> </main> </div> <div id=comments class=s-comments> <div class=utterances></div> </div> </article> </div> <footer class="text-center s-footer"> <hr> <span> Copyright &copy; Mark Lopez 2021. </span> <span> <a href=/humble-disclaimer/ >Disclaimer and Privacy Policy</a>. </span> <br> <span> Written under the <a href=https://creativecommons.org/licenses/by-sa/4.0/ >Creative Commons Attribution-ShareAlike 4.0 International License</a>. </span> <br> <span>Generated by Wyam + Webpack.</span> <span> Made with <span class=heart>&#10084;</span> by <a href=https://silvenga.com>Silvenga</a>. </span> </footer> <script async defer=defer src=/main.js></script> </body> </html>